<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å­¦ä¹ æ—¥å¿—ç¬”è®°æœ¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ““</text></svg>" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --primary: #4f46e5;
      --primary-soft: #eef2ff;
      --bg: #f4f4f5;
      --border: #e4e4e7;
      --text-main: #18181b;
      --text-sub: #71717a;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      height: 100vh;
      overflow: hidden;
      background: radial-gradient(circle at top left, #eef2ff 0, #f4f4f5 45%, #fafafa 100%);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    .app {
      max-width: 1200px;
      width: 100%;
      height: 100vh;
      margin: 0 auto;
      padding: 16px 24px 12px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    header h1 {
      font-size: 26px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header h1 span.logo-dot {
      width: 13px;
      height: 13px;
      border-radius: 999px;
      background: var(--primary);
      display: inline-block;
    }

    header .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    header label {
      font-size: 15px;
      color: var(--text-sub);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    input[type="date"] {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 15px;
      background: white;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      transition: background 0.15s, color 0.15s, border-color 0.15s, box-shadow 0.15s, opacity 0.15s;
    }

    button.primary {
      background: var(--primary);
      color: white;
    }
    button.primary:hover {
      background: #4338ca;
      box-shadow: 0 2px 8px rgba(79, 70, 229, 0.35);
    }
    button.primary:active {
      opacity: 0.85;
    }

    button.outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-sub);
    }
    button.outline:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    button.outline:active {
      opacity: 0.8;
    }

    button.small {
      padding: 5px 12px;
      font-size: 13px;
    }

    main {
      display: flex;
      gap: 0;
      align-items: stretch;
      flex: 1;
      min-height: 0;
    }

    .pane-left,
    .pane-right {
      flex-shrink: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* æœ€å°å®½åº¦ä¿è¯ h2 æ ‡é¢˜è¡Œä¸æ¢è¡Œ */
    .pane-left {
      flex: 1.2;
      min-width: 310px;
    }

    .pane-right {
      flex: 1;
      min-width: 250px;
    }

    .resize-handle {
      width: 14px;
      flex-shrink: 0;
      cursor: col-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      user-select: none;
    }

    .resize-handle::after {
      content: '';
      width: 3px;
      height: 44px;
      background: var(--border);
      border-radius: 3px;
      transition: background 0.2s, transform 0.2s;
    }

    .resize-handle:hover::after,
    .resize-handle.dragging::after {
      background: var(--primary);
      transform: scaleX(1.5);
    }

    @media (max-width: 800px) {
      main {
        flex-direction: column;
      }

      .pane-left,
      .pane-right {
        width: 100% !important;
        flex: none !important;
      }

      .resize-handle {
        display: none;
      }
    }

    .card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      border: 1px solid rgba(228, 228, 231, 0.9);
      padding: 16px 22px 14px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
      backdrop-filter: blur(12px);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-main);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .card h2 span.sub {
      font-size: 14px;
      color: var(--text-sub);
      font-weight: normal;
    }

    textarea {
      width: 100%;
      flex: 1;
      min-height: 0;
      resize: none;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      font-size: 16px;
      line-height: 1.6;
      font-family: inherit;
      box-sizing: border-box;
    }

    textarea:focus,
    input[type="date"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.2);
    }

    .card-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    .hint {
      font-size: 13px;
      color: var(--text-sub);
    }

    .hint code {
      background: var(--bg);
      padding: 1px 5px;
      border-radius: 4px;
      font-size: 12px;
    }

    .section {
      margin-top: 12px;
      flex-shrink: 0;
    }

    /* å³ä¾§æœ€åä¸€ä¸ª sectionï¼ˆç¬”è®°åˆ—è¡¨ï¼‰æ’‘æ»¡å‰©ä½™é«˜åº¦ */
    .pane-right .section:last-child {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    .section-title {
      font-size: 14px;
      color: var(--text-sub);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .tags-container,
    .note-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag-chip {
      font-size: 13px;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      color: var(--text-sub);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: border-color 0.15s, color 0.15s, opacity 0.15s;
    }

    .tag-chip:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .tag-chip:active {
      opacity: 0.75;
    }

    .tag-chip.active {
      background: var(--primary-soft);
      border-color: var(--primary);
      color: var(--primary);
      font-weight: 500;
    }

    .tag-chip.active:hover {
      border-color: #4338ca;
      color: #4338ca;
    }

    .tag-chip span.count {
      font-size: 12px;
      opacity: 0.7;
    }

    .note-list {
      margin-top: 6px;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding-right: 4px;
    }

    #titleInput {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 15px;
      font-weight: 600;
      background: white;
      margin-bottom: 8px;
      outline: none;
      flex-shrink: 0;
      box-sizing: border-box;
    }

    #titleInput:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79,70,229,.1);
    }

    .note-item {
      border-radius: 12px;
      border: 1px solid #e4e4e7;
      padding: 10px 14px;
      margin-bottom: 10px;
      background: #fdfdfd;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      transition: border-color .15s, box-shadow .15s;
    }

    .note-item:hover {
      border-color: #c7d2fe;
      box-shadow: 0 2px 8px rgba(79,70,229,.07);
    }

    .note-item.editing {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79,70,229,.12);
      background: #f5f3ff;
    }

    .note-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
      line-height: 1.3;
    }

    .note-date {
      font-size: 12px;
      color: var(--text-sub);
      font-weight: 500;
    }

    .note-body {
      font-size: 15px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .note-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 2px;
    }

    .note-time {
      font-size: 11px;
      color: var(--text-sub);
      margin-left: auto;
    }

    .note-tags {
      margin-top: 2px;
    }

    .note-tags .tag-chip {
      cursor: pointer;
      border-radius: 999px;
      background: var(--primary-soft);
      border-color: transparent;
      color: var(--primary);
      font-size: 12px;
    }

    .note-empty {
      font-size: 14px;
      color: var(--text-sub);
      padding: 16px 4px;
      text-align: center;
    }

    .ctx-menu {
      position: fixed;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,.12);
      padding: 4px 0;
      z-index: 9999;
      min-width: 130px;
      user-select: none;
    }

    .ctx-menu-item {
      padding: 9px 16px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-main);
      transition: background .1s;
    }

    .ctx-menu-item:hover {
      background: var(--bg);
    }

    .ctx-menu-item.danger {
      color: var(--danger);
    }

    .filter-info {
      font-size: 13px;
      color: var(--text-sub);
    }

    .danger-link {
      font-size: 12px;
      color: var(--danger);
      cursor: pointer;
      text-decoration: underline;
      opacity: 0.7;
    }

    .sync-badge {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
      white-space: nowrap;
    }
    .sync-online  { background: #f0fdf4; color: #16a34a; border-color: #86efac; }
    .sync-offline { background: #fafafa; color: var(--text-sub); border-color: var(--border); }
    .sync-syncing { background: #eff6ff; color: #2563eb; border-color: #93c5fd; }
    .sync-error   { background: #fef2f2; color: var(--danger); border-color: #fca5a5; }

    /* --- æ ‡ç­¾é€‰æ‹©å¼¹çª— --- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
      backdrop-filter: blur(5px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.15s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    .modal-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 24px 64px rgba(15, 23, 42, 0.18);
      width: 100%;
      max-width: 500px;
      padding: 26px 28px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      animation: slideUp 0.18s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(12px); opacity: 0; }
      to   { transform: translateY(0);    opacity: 1; }
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-main);
      margin: 0 0 4px;
    }

    .modal-preview {
      font-size: 13px;
      color: var(--text-sub);
      background: var(--bg);
      border-radius: 8px;
      padding: 8px 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.4;
    }

    .modal-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .modal-section-label {
      font-size: 12px;
      color: var(--text-sub);
      font-weight: 500;
    }

    .modal-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 30px;
    }

    .modal-tag {
      font-size: 13px;
      padding: 5px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      color: var(--text-sub);
      cursor: pointer;
      user-select: none;
      transition: background 0.12s, border-color 0.12s, color 0.12s;
    }

    .modal-tag.selected {
      background: var(--primary-soft);
      border-color: var(--primary);
      color: var(--primary);
      font-weight: 500;
    }

    .modal-tag.custom {
      background: #f0fdf4;
      border-color: #86efac;
      color: #16a34a;
    }

    .modal-tag.custom.selected {
      background: #dcfce7;
      border-color: #4ade80;
      color: #15803d;
    }

    .modal-custom-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .modal-custom-row input {
      flex: 1;
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .modal-custom-row input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.15);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding-top: 6px;
      border-top: 1px solid var(--border);
    }

    .modal-empty-hint {
      font-size: 12px;
      color: var(--text-sub);
      font-style: italic;
    }

    /* â”€â”€ ç»Ÿä¸€ç¡®è®¤å¼¹çª— â”€â”€ */
    .confirm-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      backdrop-filter: blur(5px);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.15s ease;
    }

    .confirm-card {
      background: white;
      border-radius: 18px;
      box-shadow: 0 24px 64px rgba(15, 23, 42, 0.2);
      width: 100%;
      max-width: 360px;
      padding: 28px 28px 22px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      animation: slideUp 0.18s ease;
    }

    .confirm-icon {
      font-size: 32px;
      line-height: 1;
    }

    .confirm-message {
      font-size: 15px;
      color: var(--text-main);
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .confirm-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding-top: 6px;
      border-top: 1px solid var(--border);
    }

    /* å±é™©æ“ä½œæŒ‰é’®ï¼ˆçº¢è‰²ï¼‰*/
    button.danger {
      background: #ef4444;
      color: white;
    }
    button.danger:hover {
      background: #dc2626;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.35);
    }
    button.danger:active {
      opacity: 0.85;
    }

    /* â”€â”€ æ›´æ–°æ—¥å¿—æŠ½å±‰ â”€â”€ */
    .changelog-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-sub);
      font-size: 13px;
      padding: 5px 12px;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: border-color 0.15s, color 0.15s;
    }
    .changelog-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .changelog-drawer {
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: 380px;
      max-width: 95vw;
      background: #fff;
      box-shadow: -8px 0 40px rgba(15, 23, 42, 0.14);
      z-index: 1100;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.24s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .changelog-drawer.open {
      transform: translateX(0);
    }
    .changelog-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.3);
      backdrop-filter: blur(3px);
      z-index: 1099;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.24s ease;
    }
    .changelog-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }
    .changelog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 22px 24px 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .changelog-header h2 {
      margin: 0;
      font-size: 17px;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .changelog-close {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-sub);
      padding: 4px 8px;
      border-radius: 8px;
      line-height: 1;
    }
    .changelog-close:hover { background: var(--bg); color: var(--text-main); }
    .changelog-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .cl-entry {
      display: flex;
      gap: 14px;
    }
    .cl-line {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-shrink: 0;
    }
    .cl-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--primary);
      flex-shrink: 0;
      margin-top: 4px;
    }
    .cl-dot.minor { background: #10b981; }
    .cl-dot.fix   { background: #f59e0b; }
    .cl-dot.init  { background: #a1a1aa; }
    .cl-connector {
      width: 2px;
      flex: 1;
      background: var(--border);
      margin-top: 4px;
    }
    .cl-content { flex: 1; min-width: 0; }
    .cl-version-row {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }
    .cl-version {
      font-size: 14px;
      font-weight: 700;
      color: var(--primary);
    }
    .cl-date {
      font-size: 12px;
      color: var(--text-sub);
    }
    .cl-desc {
      font-size: 13px;
      color: var(--text-main);
      font-weight: 600;
      margin-bottom: 6px;
    }
    .cl-items {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .cl-items li {
      font-size: 12.5px;
      color: var(--text-sub);
      padding-left: 12px;
      position: relative;
    }
    .cl-items li::before {
      content: "Â·";
      position: absolute;
      left: 2px;
      color: var(--primary);
      font-size: 16px;
      line-height: 1;
      top: -1px;
    }
    .cl-tag {
      display: inline-block;
      font-size: 10px;
      padding: 1px 7px;
      border-radius: 999px;
      font-weight: 600;
      letter-spacing: 0.3px;
      margin-left: 4px;
      vertical-align: middle;
    }
    .cl-tag.feat  { background: #ede9fe; color: #7c3aed; }
    .cl-tag.fix   { background: #fef3c7; color: #b45309; }
    .cl-tag.infra { background: #ecfdf5; color: #065f46; }
  </style>
  <!-- è…¾è®¯äº‘å¼€å‘ Web SDK -->
  <!-- éœ€ 2.24+ æ‰æ”¯æŒ signInWithPassword / signInAnonymously ç­‰æ–°è®¤è¯ API -->
  <script src="https://static.cloudbase.net/cloudbase-js-sdk/latest/cloudbase.full.js"></script>
</head>
<body>
<div class="app">
  <header>
    <h1>
      <span class="logo-dot"></span>
      å­¦ä¹ æ—¥å¿— Â· ç¬”è®°æœ¬
      <span style="font-size:11px;font-weight:400;color:var(--text-sub);margin-left:6px;">v0.2.4</span>
    </h1>
    <div class="controls">
      <span id="syncBadge" class="sync-badge sync-offline">â—‹ è¿æ¥ä¸­â€¦</span>
      <label>
        æ—¥æœŸ
        <input id="dateInput" type="date" />
      </label>
      <button id="todayBtn" class="outline small">è·³åˆ°ä»Šå¤©</button>
      <button id="changelogBtn" class="changelog-btn" title="ç‰ˆæœ¬æ›´æ–°è®°å½•">ğŸ“‹ æ›´æ–°è®°å½•</button>
    </div>
  </header>

  <!-- æ›´æ–°æ—¥å¿—æŠ½å±‰é®ç½© -->
  <div id="changelogBackdrop" class="changelog-backdrop"></div>

  <!-- æ›´æ–°æ—¥å¿—æŠ½å±‰ -->
  <div id="changelogDrawer" class="changelog-drawer">
    <div class="changelog-header">
      <h2>ğŸ“‹ ç‰ˆæœ¬æ›´æ–°è®°å½•</h2>
      <button class="changelog-close" id="changelogClose" title="å…³é—­">âœ•</button>
    </div>
    <div class="changelog-body" id="changelogBody"></div>
  </div>

  <main>
    <!-- å·¦ä¾§ï¼šå†™ç¬”è®° -->
    <section class="card pane-left" id="paneLeft">
      <h2>
        å†™ä»Šå¤©çš„å­¦ä¹ æ—¥å¿—
        <span class="sub" id="charCount">0 å­—</span>
      </h2>
      <input id="titleInput" type="text" placeholder="æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰" maxlength="60" />
      <textarea id="noteInput" placeholder="ä»Šå¤©å­¦äº†ä»€ä¹ˆï¼Ÿé‡åˆ°ä»€ä¹ˆé—®é¢˜ï¼Ÿç”¨è‡ªå·±çš„è¯æ€»ç»“ä¸€ä¸‹å§ï½&#10;Tips: è¾“å…¥ #æ ‡ç­¾ å½¢å¼çš„å…³é”®è¯ï¼Œä¼šè‡ªåŠ¨æˆä¸º tagï¼Œä¾‹å¦‚ï¼š#Unity #ç®—æ³• #é˜…è¯»"></textarea>
      <div class="card-footer">
        <div class="hint">
          è‡ªåŠ¨æå–æ ‡ç­¾è§„åˆ™ï¼š
          <code>#æ ‡ç­¾</code> +
          <code>åŒ…å«å·²æœ‰æ ‡ç­¾æ–‡æœ¬</code>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="cancelEditBtn" class="outline small" style="display:none;">âœ• å–æ¶ˆç¼–è¾‘</button>
          <button id="saveBtn" class="primary">ä¿å­˜æ—¥å¿—</button>
        </div>
      </div>
    </section>

    <div class="resize-handle" id="resizeHandle" title="æ‹–æ‹½è°ƒèŠ‚å®½åº¦"></div>

    <!-- å³ä¾§ï¼štag & ç¬”è®°åˆ—è¡¨ -->
    <section class="card pane-right" id="paneRight">
      <h2>
        ç¬”è®°ä¸æ ‡ç­¾
        <span class="sub" id="noteSummary">å…± 0 æ¡ç¬”è®°</span>
      </h2>

      <div class="section">
        <div class="section-title">
          <span>è‡ªåŠ¨æ ‡ç­¾ï¼ˆå·¦é”®ç­›é€‰ / å³é”®åˆ é™¤ï¼‰</span>
          <div class="filter-info" id="filterInfo">æœªç­›é€‰</div>
        </div>
        <div class="tags-container" id="tagList"></div>
      </div>

      <div class="section">
        <div class="section-title">
          <span>ç¬”è®°åˆ—è¡¨</span>
          <span class="danger-link" id="clearAllBtn">æ¸…ç©ºæ‰€æœ‰æ•°æ®</span>
        </div>
        <div class="note-list" id="noteList"></div>
      </div>
    </section>
  </main>
</div>

<!-- æ ‡ç­¾é€‰æ‹©å¼¹çª— -->
<div id="ctxMenu" class="ctx-menu" style="display:none;">
  <div class="ctx-menu-item danger" id="ctxDelete">ğŸ—‘ åˆ é™¤ç¬”è®°</div>
</div>

<div id="tagCtxMenu" class="ctx-menu" style="display:none;">
  <div class="ctx-menu-item" id="tagCtxFilter">ğŸ· ç­›é€‰æ­¤æ ‡ç­¾</div>
  <div class="ctx-menu-item danger" id="tagCtxDelete">ğŸ—‘ åˆ é™¤æ ‡ç­¾ï¼ˆæ‰€æœ‰ç¬”è®°ï¼‰</div>
</div>

<!-- ç¬”è®°å¡ç‰‡å†… tag å³é”®èœå•ï¼šä»…ä»æœ¬æ¡ç¬”è®°ä¸­åˆ é™¤ -->
<div id="noteTagCtxMenu" class="ctx-menu" style="display:none;">
  <div class="ctx-menu-item" id="noteTagCtxFilter">ğŸ· ç­›é€‰æ­¤æ ‡ç­¾</div>
  <div class="ctx-menu-item danger" id="noteTagCtxDelete">ğŸ—‘ ä»æœ¬æ¡ç¬”è®°ä¸­åˆ é™¤</div>
</div>

<div id="tagModal" class="modal-overlay" style="display:none;">
  <div class="modal-card">
    <div>
      <div class="modal-title">ç¡®è®¤æ ‡ç­¾</div>
      <div class="modal-preview" id="modalPreview"></div>
    </div>

    <div class="modal-section" id="modalAutoSection">
      <div class="modal-section-label">è‡ªåŠ¨æå–ï¼ˆå·²é¢„é€‰ï¼Œå¯å–æ¶ˆï¼‰</div>
      <div class="modal-tags" id="modalAutoTags"></div>
    </div>

    <div class="modal-section" id="modalExistingSection">
      <div class="modal-section-label">å·²æœ‰æ ‡ç­¾ï¼ˆç‚¹å‡»æ·»åŠ ï¼‰</div>
      <div class="modal-tags" id="modalExistingTags"></div>
    </div>

    <div class="modal-section">
      <div class="modal-section-label">è‡ªå®šä¹‰æ ‡ç­¾</div>
      <div class="modal-custom-row">
        <input type="text" id="modalCustomInput" placeholder="è¾“å…¥æ–°æ ‡ç­¾ï¼Œå›è½¦æˆ–ç‚¹å‡»æ·»åŠ " maxlength="20" />
        <button id="modalAddBtn" class="outline small">æ·»åŠ </button>
      </div>
      <div class="modal-tags" id="modalCustomTags"></div>
    </div>

    <div class="modal-footer">
      <button id="modalCancelBtn" class="outline">å–æ¶ˆ</button>
      <button id="modalConfirmBtn" class="primary">ä¿å­˜ç¬”è®°</button>
    </div>
  </div>
</div>

<!-- ç»Ÿä¸€ç¡®è®¤å¼¹çª— -->
<div id="confirmModal" class="confirm-overlay" style="display:none;">
  <div class="confirm-card">
    <div class="confirm-icon" id="confirmIcon">âš ï¸</div>
    <div class="confirm-message" id="confirmMessage"></div>
    <div class="confirm-footer">
      <button id="confirmCancelBtn" class="outline">å–æ¶ˆ</button>
      <button id="confirmOkBtn" class="danger">ç¡®è®¤</button>
    </div>
  </div>
</div>

<script>
  // --- è…¾è®¯äº‘å¼€å‘ TCB SDK (2.24+ è®¤è¯ API) ---
  const tcbApp = cloudbase.init({
    env: "kt-notebook-5gzea6as40f0fb41",
    region: "ap-shanghai",
    auth: { detectSessionInUrl: true }
  });
  const tcbAuth = tcbApp.auth();
  const CLOUD_PATH     = "notes/notebook.json";
  const STORAGE_KEY    = "study_notes_v1";
  const FILE_ID_KEY    = "cloud_file_id_v1";
  // å…œåº• fileIDï¼šbucket åç§°ä»æ§åˆ¶å°äº‘å­˜å‚¨åˆ—è¡¨ç¡®è®¤ä¸º 6b74-kt-notebook-5gzea6as40f0fb41-1313442109
  const CLOUD_FILE_ID_DEFAULT = "cloud://kt-notebook-5gzea6as40f0fb41.6b74-kt-notebook-5gzea6as40f0fb41-1313442109/notes/notebook.json";

  /**
   * @typedef {Object} Note
   * @property {number}   id
   * @property {string}   date      YYYY-MM-DDï¼ˆæ—¥æœŸï¼Œç”¨äºåˆ†ç»„/ç­›é€‰ï¼‰
   * @property {string}   datetime  YYYY-MM-DD HH:mm:ssï¼ˆå®Œæ•´åˆ›å»ºæ—¶é—´ï¼Œäººç±»å¯è¯»ï¼‰
   * @property {string}   text
   * @property {string[]} tags
   * @property {number}   createdAt æ¯«ç§’æ—¶é—´æˆ³ï¼ˆç”¨äºæ’åºå’Œåˆå¹¶å»é‡ï¼‰
   */

  /** @type {Note[]} */
  let notes = [];
  let activeTag = null;

  // --- ç»Ÿä¸€ç¡®è®¤å¼¹çª— ---
  (function () {
    const overlay    = document.getElementById("confirmModal");
    const msgEl      = document.getElementById("confirmMessage");
    const iconEl     = document.getElementById("confirmIcon");
    const okBtn      = document.getElementById("confirmOkBtn");
    const cancelBtn  = document.getElementById("confirmCancelBtn");
    let _cb = null;

    window.showConfirm = function (message, onConfirm, { okText = "ç¡®è®¤", icon = "âš ï¸" } = {}) {
      msgEl.textContent    = message;
      iconEl.textContent   = icon;
      okBtn.textContent    = okText;
      _cb = onConfirm;
      overlay.style.display = "flex";
    };

    function hide() {
      overlay.style.display = "none";
      _cb = null;
    }

    okBtn.addEventListener("click", () => {
      const cb = _cb;
      hide();
      if (cb) cb();
    });
    cancelBtn.addEventListener("click", hide);
    overlay.addEventListener("click", (e) => { if (e.target === overlay) hide(); });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && overlay.style.display !== "none") { e.stopPropagation(); hide(); }
    }, true);
  })();

  // --- å·¥å…·å‡½æ•° ---
  function getTodayStr() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  /** å°†ä»»æ„ Date å¯¹è±¡æ ¼å¼åŒ–ä¸º "YYYY-MM-DD HH:mm:ss" */
  function formatDatetime(d) {
    const y  = d.getFullYear();
    const mo = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");
    const h  = String(d.getHours()).padStart(2, "0");
    const mi = String(d.getMinutes()).padStart(2, "0");
    const s  = String(d.getSeconds()).padStart(2, "0");
    return `${y}-${mo}-${da} ${h}:${mi}:${s}`;
  }

  function setSyncBadge(state) {
    const el = document.getElementById("syncBadge");
    if (!el) return;
    const map = {
      online:  { text: "â— å·²åŒæ­¥",  cls: "sync-online"  },
      offline: { text: "â—‹ ç¦»çº¿",    cls: "sync-offline" },
      syncing: { text: "â†‘ åŒæ­¥ä¸­â€¦", cls: "sync-syncing" },
      error:   { text: "âœ• åŒæ­¥å¤±è´¥", cls: "sync-error"  },
    };
    const s = map[state] || map.offline;
    el.textContent = s.text;
    el.className   = "sync-badge " + s.cls;
  }

  async function saveNotes() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
    setSyncBadge("syncing");
    try {
      const blob = new Blob([JSON.stringify(notes)], { type: "application/json" });
      const file = new File([blob], "notebook.json", { type: "application/json" });
      const uploadRes = await tcbApp.uploadFile({ cloudPath: CLOUD_PATH, filePath: file });
      // æŒä¹…åŒ– SDK è¿”å›çš„çœŸå® fileIDï¼Œé¿å…æ‰‹åŠ¨æ‹¼æ¥ bucket åå‡ºé”™
      if (uploadRes?.fileID) {
        localStorage.setItem(FILE_ID_KEY, uploadRes.fileID);
        console.log("[Storage] ä¸Šä¼ æˆåŠŸï¼ŒfileID:", uploadRes.fileID);
      }
      setSyncBadge("online");
    } catch (err) {
      console.error("[Storage] äº‘å­˜å‚¨å†™å…¥å¤±è´¥ï¼š", err);
      setSyncBadge("error");
    }
  }

  function loadNotesFromLocal() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      notes = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(notes)) notes = [];
    } catch (e) { notes = []; }
  }

  /**
   * åˆå¹¶äº‘ç«¯ä¸æœ¬åœ°ç¬”è®°ï¼ˆæŒ‰ id å»é‡ï¼ŒåŒ id å– createdAt æ›´æ–°çš„ï¼‰ï¼Œé¿å…ç›´æ¥è¦†ç›–å¯¼è‡´ä¸¢æ•°æ®
   * @param {Note[]} cloudNotes äº‘ç«¯æ•°æ®
   * @param {Note[]} localNotes æœ¬åœ°æ•°æ®
   * @returns {Note[]} åˆå¹¶åçš„åˆ—è¡¨ï¼ŒæŒ‰ createdAt æ’åº
   */
  function mergeNotes(cloudNotes, localNotes) {
    const byId = new Map();
    const add = (list) => {
      if (!Array.isArray(list)) return;
      for (const n of list) {
        if (!n || n.id == null) continue;
        const existing = byId.get(n.id);
        const created = n.createdAt != null ? n.createdAt : 0;
        if (!existing || (existing.createdAt != null && created > existing.createdAt)) {
          byId.set(n.id, n);
        }
      }
    };
    add(cloudNotes);
    add(localNotes);
    return Array.from(byId.values()).sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
  }

  // è·å–å½“å‰æ‰€æœ‰å·²æœ‰æ ‡ç­¾
  function getAllExistingTags() {
    const set = new Set();
    for (const n of notes) {
      if (Array.isArray(n.tags)) {
        for (const t of n.tags) {
          if (t) set.add(t);
        }
      }
    }
    return Array.from(set);
  }

  // ç®€å•çš„æ ‡ç­¾æå–ï¼š#æ ‡ç­¾ + é«˜é¢‘è‹±æ–‡å•è¯ + æ–‡æœ¬ä¸­å‡ºç°çš„å·²æœ‰æ ‡ç­¾
  function extractTagsFromText(text, existingTags = []) {
    const tagsSet = new Set();

    // 1) è¯†åˆ« #æ ‡ç­¾
    const hashTagRegex = /#([\p{L}\d_]{1,20})/gu;
    let match;
    while ((match = hashTagRegex.exec(text)) !== null) {
      tagsSet.add(match[1]);
    }

    // 2) æ–‡æœ¬ä¸­å‡ºç°çš„å·²æœ‰æ ‡ç­¾
    const lowerText = text.toLowerCase();
    for (const tag of existingTags) {
      if (!tag) continue;
      if (lowerText.includes(tag.toLowerCase())) {
        tagsSet.add(tag);
      }
    }

    return Array.from(tagsSet);
  }

  // --- DOM å¼•ç”¨ ---
  const dateInput = document.getElementById("dateInput");
  const noteInput = document.getElementById("noteInput");
  const titleInput    = document.getElementById("titleInput");
  const saveBtn       = document.getElementById("saveBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");

  // --- ç¼–è¾‘çŠ¶æ€ ---
  let editingNoteId = null;

  function enterEditMode(note) {
    editingNoteId = note.id;
    titleInput.value = note.title || "";
    noteInput.value  = note.text;
    dateInput.value  = note.date;
    charCount.textContent = `${note.text.length} å­—`;
    saveBtn.textContent = "æ›´æ–°æ—¥å¿—";
    cancelEditBtn.style.display = "";
    // æ»šåˆ°ç¼–è¾‘åŒº
    document.getElementById("paneLeft").scrollIntoView({ behavior: "smooth", block: "start" });
    titleInput.focus();
    renderNotes(); // åˆ·æ–°é«˜äº®
  }

  function exitEditMode() {
    editingNoteId = null;
    titleInput.value = "";
    noteInput.value  = "";
    dateInput.value  = getTodayStr();
    charCount.textContent = "0 å­—";
    saveBtn.textContent = "ä¿å­˜æ—¥å¿—";
    cancelEditBtn.style.display = "none";
    renderNotes();
  }

  cancelEditBtn.addEventListener("click", exitEditMode);
  const todayBtn = document.getElementById("todayBtn");
  const charCount = document.getElementById("charCount");
  const tagListEl = document.getElementById("tagList");
  const noteListEl = document.getElementById("noteList");
  const noteSummaryEl = document.getElementById("noteSummary");
  const filterInfoEl = document.getElementById("filterInfo");
  const clearAllBtn = document.getElementById("clearAllBtn");

  // åˆ é™¤æŸä¸ªæ ‡ç­¾ï¼šä»æ‰€æœ‰ç¬”è®°ä¸­ç§»é™¤
  function deleteTagEverywhere(tagToDelete) {
    let changed = false;
    for (const note of notes) {
      if (Array.isArray(note.tags) && note.tags.includes(tagToDelete)) {
        note.tags = note.tags.filter((t) => t !== tagToDelete);
        changed = true;
      }
    }
    if (changed) {
      saveNotes();
    }
    if (activeTag === tagToDelete) {
      activeTag = null;
    }
    render();
  }

  // ç»™ tag ç»‘å®šäº‹ä»¶ï¼šå·¦é”®ç­›é€‰ï¼Œå³é”®åˆ é™¤
  // tag äº‹ä»¶ï¼šç”¨äºå·¦ä¾§æ ‡ç­¾æ ï¼ˆå³é”® â†’ å…¨å±€èœå•ï¼‰
  function attachTagEvents(tagElement, tag) {
    tagElement.addEventListener("click", (e) => {
      if (e.button !== 0) return;
      activeTag = activeTag === tag ? null : tag;
      render();
    });
    tagElement.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      e.stopPropagation();
      showTagCtxMenu(e.clientX, e.clientY, tag);
    });
  }

  // tag äº‹ä»¶ï¼šç”¨äºç¬”è®°å¡ç‰‡å†…ï¼ˆå³é”® â†’ ä»…ä»æœ¬æ¡åˆ é™¤èœå•ï¼‰
  function attachNoteTagEvents(tagElement, tag, noteId) {
    tagElement.addEventListener("click", (e) => {
      if (e.button !== 0) return;
      activeTag = activeTag === tag ? null : tag;
      render();
    });
    tagElement.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      e.stopPropagation();
      showNoteTagCtxMenu(e.clientX, e.clientY, tag, noteId);
    });
  }

  // --- æ¸²æŸ“ ---
  function render() {
    renderSummary();
    renderTags();
    renderNotes();
  }

  function renderSummary() {
    noteSummaryEl.textContent = `å…± ${notes.length} æ¡ç¬”è®°`;
    if (activeTag) {
      filterInfoEl.textContent = `æŒ‰æ ‡ç­¾ã€Œ${activeTag}ã€ç­›é€‰ä¸­`;
    } else {
      filterInfoEl.textContent = "æœªç­›é€‰";
    }
  }

  function renderTags() {
    const tagCount = new Map();
    for (const n of notes) {
      for (const t of n.tags || []) {
        tagCount.set(t, (tagCount.get(t) || 0) + 1);
      }
    }

    tagListEl.innerHTML = "";
    if (tagCount.size === 0) {
      const span = document.createElement("span");
      span.className = "hint";
      span.textContent = "æš‚æ— æ ‡ç­¾ï¼Œå†™å‡ æ¡æ—¥å¿—è¯•è¯•å§ï½";
      tagListEl.appendChild(span);
      return;
    }

    const sortedTags = [...tagCount.entries()].sort((a, b) => b[1] - a[1]);

    for (const [tag, count] of sortedTags) {
      const div = document.createElement("div");
      div.className = "tag-chip" + (activeTag === tag ? " active" : "");
      div.textContent = tag;

      const countSpan = document.createElement("span");
      countSpan.className = "count";
      countSpan.textContent = `Ã—${count}`;
      div.appendChild(countSpan);

      attachTagEvents(div, tag);
      tagListEl.appendChild(div);
    }
  }

  // è‡ªåŠ¨ç”Ÿæˆæ ‡é¢˜ï¼šå–æ­£æ–‡ç¬¬ä¸€è¡Œå‰5å­—ï¼Œè¶…å‡ºåŠ ...
  function autoTitle(text) {
    const firstLine = text.split("\n")[0].trim();
    return firstLine.length <= 5 ? firstLine : firstLine.slice(0, 5) + "â€¦";
  }

  // --- ç¬”è®°å³é”®èœå• ---
  const ctxMenu   = document.getElementById("ctxMenu");
  const ctxDelete = document.getElementById("ctxDelete");
  let ctxNoteId   = null;

  function showCtxMenu(x, y, noteId) {
    hideTagCtxMenu();
    ctxNoteId = noteId;
    ctxMenu.style.display = "block";
    const menuW = 140, menuH = 50;
    ctxMenu.style.left = (x + menuW > window.innerWidth  ? x - menuW : x) + "px";
    ctxMenu.style.top  = (y + menuH > window.innerHeight ? y - menuH : y) + "px";
  }

  function hideCtxMenu() {
    ctxMenu.style.display = "none";
    ctxNoteId = null;
  }

  // --- Tag å³é”®èœå• ---
  const tagCtxMenu    = document.getElementById("tagCtxMenu");
  const tagCtxFilter  = document.getElementById("tagCtxFilter");
  const tagCtxDeleteEl= document.getElementById("tagCtxDelete");
  let ctxTag = null;

  function showTagCtxMenu(x, y, tag) {
    hideCtxMenu();
    ctxTag = tag;
    // åŠ¨æ€æ›´æ–°ç­›é€‰é¡¹æ–‡å­—ï¼Œåæ˜ å½“å‰çŠ¶æ€
    tagCtxFilter.textContent = activeTag === tag ? "ğŸ· å–æ¶ˆç­›é€‰" : "ğŸ· ç­›é€‰æ­¤æ ‡ç­¾";
    tagCtxMenu.style.display = "block";
    const menuW = 190, menuH = 80;
    tagCtxMenu.style.left = (x + menuW > window.innerWidth  ? x - menuW : x) + "px";
    tagCtxMenu.style.top  = (y + menuH > window.innerHeight ? y - menuH : y) + "px";
  }

  function hideTagCtxMenu() {
    tagCtxMenu.style.display = "none";
    ctxTag = null;
  }

  tagCtxFilter.addEventListener("click", () => {
    if (!ctxTag) return;
    activeTag = activeTag === ctxTag ? null : ctxTag;
    render();
    hideTagCtxMenu();
  });

  tagCtxDeleteEl.addEventListener("click", () => {
    if (!ctxTag) return;
    const tag = ctxTag;
    hideTagCtxMenu();
    showConfirm(
      `ä»æ‰€æœ‰ç¬”è®°ä¸­åˆ é™¤æ ‡ç­¾ã€Œ${tag}ã€ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
      () => deleteTagEverywhere(tag),
      { okText: "ç¡®è®¤åˆ é™¤", icon: "ğŸ—‘ï¸" }
    );
  });

  // --- ç¬”è®°å¡ç‰‡å†… tag å³é”®èœå•ï¼ˆä»…ä»æœ¬æ¡ç¬”è®°åˆ é™¤ï¼‰---
  const noteTagCtxMenu      = document.getElementById("noteTagCtxMenu");
  const noteTagCtxFilterEl  = document.getElementById("noteTagCtxFilter");
  const noteTagCtxDeleteEl  = document.getElementById("noteTagCtxDelete");
  let ctxNoteTagInfo = null; // { tag, noteId }

  function showNoteTagCtxMenu(x, y, tag, noteId) {
    hideCtxMenu(); hideTagCtxMenu();
    ctxNoteTagInfo = { tag, noteId };
    noteTagCtxFilterEl.textContent = activeTag === tag ? "ğŸ· å–æ¶ˆç­›é€‰" : "ğŸ· ç­›é€‰æ­¤æ ‡ç­¾";
    noteTagCtxMenu.style.display = "block";
    const menuW = 190, menuH = 80;
    noteTagCtxMenu.style.left = (x + menuW > window.innerWidth  ? x - menuW : x) + "px";
    noteTagCtxMenu.style.top  = (y + menuH > window.innerHeight ? y - menuH : y) + "px";
  }

  function hideNoteTagCtxMenu() {
    noteTagCtxMenu.style.display = "none";
    ctxNoteTagInfo = null;
  }

  noteTagCtxFilterEl.addEventListener("click", () => {
    if (!ctxNoteTagInfo) return;
    activeTag = activeTag === ctxNoteTagInfo.tag ? null : ctxNoteTagInfo.tag;
    render();
    hideNoteTagCtxMenu();
  });

  noteTagCtxDeleteEl.addEventListener("click", () => {
    if (!ctxNoteTagInfo) return;
    const { tag, noteId } = ctxNoteTagInfo;
    hideNoteTagCtxMenu();
    showConfirm(
      `ä»æœ¬æ¡ç¬”è®°ä¸­åˆ é™¤æ ‡ç­¾ã€Œ${tag}ã€ï¼Ÿ`,
      () => {
        const note = notes.find(n => n.id === noteId);
        if (note) {
          note.tags = note.tags.filter(t => t !== tag);
          saveNotes();
          render();
        }
      },
      { okText: "ç¡®è®¤åˆ é™¤", icon: "ğŸ·ï¸" }
    );
  });

  document.addEventListener("click", () => { hideCtxMenu(); hideTagCtxMenu(); hideNoteTagCtxMenu(); });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") { hideCtxMenu(); hideTagCtxMenu(); hideNoteTagCtxMenu(); }
  });

  ctxDelete.addEventListener("click", () => {
    if (ctxNoteId == null) return;
    const id = ctxNoteId;
    hideCtxMenu();
    showConfirm(
      "ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",
      () => {
        notes = notes.filter(n => n.id !== id);
        saveNotes();
        render();
      },
      { okText: "åˆ é™¤ç¬”è®°", icon: "ğŸ—‘ï¸" }
    );
  });

  function renderNotes() {
    noteListEl.innerHTML = "";
    let list = notes.slice();

    list.sort((a, b) => b.createdAt - a.createdAt);

    if (activeTag) {
      list = list.filter((n) => n.tags && n.tags.includes(activeTag));
    }

    if (list.length === 0) {
      const empty = document.createElement("div");
      empty.className = "note-empty";
      empty.textContent = activeTag
        ? "å½“å‰æ ‡ç­¾ä¸‹è¿˜æ²¡æœ‰ç¬”è®°ï½"
        : "è¿˜æ²¡æœ‰ä»»ä½•ç¬”è®°ï¼Œè¯•ç€å†™ä¸€æ¡å§ã€‚";
      noteListEl.appendChild(empty);
      return;
    }

    for (const note of list) {
      const item = document.createElement("div");
      item.className = "note-item";

      // å·¦é”®ï¼šåŠ è½½åˆ°ç¼–è¾‘å™¨
      item.addEventListener("click", () => enterEditMode(note));

      // ç¼–è¾‘ä¸­é«˜äº®
      if (note.id === editingNoteId) item.classList.add("editing");

      // å³é”®èœå•
      item.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        e.stopPropagation();
        showCtxMenu(e.clientX, e.clientY, note.id);
      });

      // å·¦ä¸Šè§’ï¼šæœ‰æ ‡é¢˜ç”¨æ ‡é¢˜ï¼Œå¦åˆ™ä»æ­£æ–‡è‡ªåŠ¨ç”Ÿæˆ
      const titleEl = document.createElement("div");
      titleEl.className = "note-title";
      titleEl.textContent = note.title || autoTitle(note.text);

      const body = document.createElement("div");
      body.className = "note-body";
      // æœ€å¤šæ˜¾ç¤º 5 è¡Œï¼šè¶…å‡ºæ—¶ä¿ç•™å‰ 4 è¡Œï¼Œç¬¬ 5 è¡Œæ˜¾ç¤ºçœç•¥å·
      const bodyLines = (note.text || "").split("\n");
      body.textContent = bodyLines.length > 5
        ? bodyLines.slice(0, 4).join("\n") + "\nâ€¦"
        : note.text;

      item.appendChild(titleEl);
      item.appendChild(body);

      if (note.tags && note.tags.length > 0) {
        const tagContainer = document.createElement("div");
        tagContainer.className = "note-tags";

        for (const t of note.tags) {
          const tagEl = document.createElement("span");
          tagEl.className = "tag-chip small";
          tagEl.textContent = t;

          attachNoteTagEvents(tagEl, t, note.id);
          tagContainer.appendChild(tagEl);
        }
        item.appendChild(tagContainer);
      }

      // å³ä¸‹è§’ï¼šæ—¶é—´ç²¾ç¡®åˆ°åˆ†é’Ÿ
      const footer = document.createElement("div");
      footer.className = "note-footer";

      const dateSpan = document.createElement("span");
      dateSpan.className = "note-date";
      dateSpan.textContent = note.date;
      footer.appendChild(dateSpan);

      const timeSpan = document.createElement("span");
      timeSpan.className = "note-time";
      const d = new Date(note.createdAt);
      timeSpan.textContent = d.toLocaleString([], {
        month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit"
      });
      footer.appendChild(timeSpan);

      item.appendChild(footer);
      noteListEl.appendChild(item);
    }
  }

  // --- æ ‡ç­¾é€‰æ‹©å¼¹çª— ---
  const tagModalEl      = document.getElementById("tagModal");
  const modalPreviewEl  = document.getElementById("modalPreview");
  const modalAutoEl     = document.getElementById("modalAutoTags");
  const modalExistEl    = document.getElementById("modalExistingTags");
  const modalCustomEl   = document.getElementById("modalCustomTags");
  const modalCustomInput = document.getElementById("modalCustomInput");
  const modalAutoSection  = document.getElementById("modalAutoSection");
  const modalExistSection = document.getElementById("modalExistingSection");

  // å¼¹çª—çŠ¶æ€
  const modal = {
    pendingText: "",
    pendingTitle: "",
    pendingDate: "",
    selectedSet: new Set(),
    customTags: [],
  };

  function renderModalTagList(container, tags, isCustom = false) {
    container.innerHTML = "";
    if (tags.length === 0) {
      const hint = document.createElement("span");
      hint.className = "modal-empty-hint";
      hint.textContent = "ï¼ˆæ— ï¼‰";
      container.appendChild(hint);
      return;
    }
    for (const tag of tags) {
      const chip = document.createElement("span");
      chip.className = "modal-tag" + (isCustom ? " custom" : "") + (modal.selectedSet.has(tag) ? " selected" : "");
      chip.textContent = tag;
      chip.addEventListener("click", () => {
        if (modal.selectedSet.has(tag)) {
          modal.selectedSet.delete(tag);
        } else {
          modal.selectedSet.add(tag);
        }
        chip.classList.toggle("selected", modal.selectedSet.has(tag));
      });
      container.appendChild(chip);
    }
  }

  function openTagModal(text, date, title, preselectedTags) {
    modal.pendingText  = text;
    modal.pendingDate  = date;
    modal.pendingTitle = title || "";
    modal.customTags  = [];
    modal.selectedSet = new Set(preselectedTags || []);

    // è‡ªåŠ¨æå–å¹¶é¢„é€‰
    const existingTags = getAllExistingTags();
    const autoTags     = extractTagsFromText(text, existingTags);
    autoTags.forEach(t => modal.selectedSet.add(t));

    // å·²æœ‰æ ‡ç­¾ä¸­æ’é™¤è‡ªåŠ¨æå–çš„
    const extraExisting = existingTags.filter(t => !autoTags.includes(t));

    // é¢„è§ˆæ–‡æœ¬
    modalPreviewEl.textContent = text.length > 80 ? text.slice(0, 80) + "â€¦" : text;

    // æ¸²æŸ“å„åŒºåŸŸ
    modalAutoSection.style.display = autoTags.length ? "" : "none";
    renderModalTagList(modalAutoEl, autoTags, false);

    modalExistSection.style.display = extraExisting.length ? "" : "none";
    renderModalTagList(modalExistEl, extraExisting, false);

    modalCustomEl.innerHTML = "";
    modalCustomInput.value  = "";

    tagModalEl.style.display = "flex";
    setTimeout(() => modalCustomInput.focus(), 50);
  }

  function closeTagModal() {
    tagModalEl.style.display = "none";
    modal.pendingText  = "";
    modal.pendingTitle = "";
    modal.pendingDate = "";
  }

  function addCustomTag() {
    const val = modalCustomInput.value.trim();
    if (!val) return;
    if (modal.customTags.includes(val) || modal.selectedSet.has(val)) {
      modalCustomInput.value = "";
      return;
    }
    modal.customTags.push(val);
    modal.selectedSet.add(val);
    renderModalTagList(modalCustomEl, modal.customTags, true);
    modalCustomInput.value = "";
    modalCustomInput.focus();
  }

  document.getElementById("modalAddBtn").addEventListener("click", addCustomTag);

  modalCustomInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); addCustomTag(); }
  });

  document.getElementById("modalCancelBtn").addEventListener("click", closeTagModal);

  // ç‚¹å‡»é®ç½©å…³é—­
  tagModalEl.addEventListener("click", (e) => {
    if (e.target === tagModalEl) closeTagModal();
  });

  document.getElementById("modalConfirmBtn").addEventListener("click", () => {
    const finalTags = Array.from(modal.selectedSet);
    const now = new Date();

    if (editingNoteId != null) {
      // æ›´æ–°å·²æœ‰ç¬”è®°ï¼šä¿å­˜åä¿ç•™ç¼–è¾‘å™¨å†…å®¹ï¼Œä»…é€€å‡ºç¼–è¾‘çŠ¶æ€
      const idx = notes.findIndex(n => n.id === editingNoteId);
      if (idx !== -1) {
        notes[idx] = {
          ...notes[idx],
          title:    modal.pendingTitle,
          date:     modal.pendingDate,
          datetime: formatDatetime(now),
          text:     modal.pendingText,
          tags:     finalTags,
        };
      }
      saveNotes();
      closeTagModal();
      // ä»…é‡ç½®ç¼–è¾‘çŠ¶æ€ï¼Œä¸æ¸…ç©ºç¼–è¾‘å™¨å†…å®¹
      editingNoteId = null;
      saveBtn.textContent = "ä¿å­˜æ—¥å¿—";
      cancelEditBtn.style.display = "none";
      render();
    } else {
      // æ–°å»ºç¬”è®°
      const newNote = {
        id: now.getTime(),
        date: modal.pendingDate,
        title: modal.pendingTitle,
        datetime: formatDatetime(now),
        text: modal.pendingText,
        tags: finalTags,
        createdAt: now.getTime(),
      };
      notes.push(newNote);
      saveNotes();
      titleInput.value = "";
      noteInput.value  = "";
      charCount.textContent = "0 å­—";
      closeTagModal();
      render();
    }
  });

  // --- äº‹ä»¶ç»‘å®š ---
  saveBtn.addEventListener("click", () => {
    const text  = noteInput.value.trim();
    const date  = dateInput.value || getTodayStr();
    const title = titleInput.value.trim();

    if (!text) {
      alert("å†…å®¹ä¸ºç©ºï¼Œå…ˆå†™ç‚¹ä¸œè¥¿å†ä¿å­˜å§ï½");
      return;
    }

    // ç¼–è¾‘æ—¶é¢„é€‰å·²æœ‰æ ‡ç­¾
    const preselected = editingNoteId != null
      ? (notes.find(n => n.id === editingNoteId)?.tags || [])
      : [];

    openTagModal(text, date, title, preselected);
  });

  noteInput.addEventListener("input", () => {
    const len = noteInput.value.length;
    charCount.textContent = `${len} å­—`;
  });

  // --- Tab ç¼©è¿› + è‡ªåŠ¨ç¼–å· / Shift+Tab å›é€€å±‚çº§ / Backspace å›é€€ç¼©è¿› ---
  const INDENT = "  "; // 2ç©ºæ ¼ä¸ºä¸€çº§ç¼©è¿›
  const PREFIX_RE = /^(\d+\. |[a-z]\. |- )/;

  function lineLevel(line) {
    const m = line.match(/^(\s*)/);
    return m ? Math.floor(m[1].length / INDENT.length) : 0;
  }

  function lineContent(line) {
    return line.replace(/^\s*/, "").replace(PREFIX_RE, "");
  }

  // å…¨å±€é‡æ–°ç¼–å·ï¼šæŒ‰é¡ºåºæ‰«ææ‰€æœ‰è¡Œï¼Œä¸ºæ¯ä¸ªç¼–å·è¡Œèµ‹æ­£ç¡®åºå·
  function renumberAll(text) {
    const lines = text.split("\n");
    const counters = {}; // level -> å½“å‰è®¡æ•°
    return lines.map(line => {
      const level   = lineLevel(line);
      const trimmed = line.trimStart();
      // é‡åˆ°æ¯”å½“å‰ level æ·±çš„ counter è¦æ¸…æ‰ï¼ˆè¿›å…¥æ–°çˆ¶æ¡ç›®æ—¶å­çº§é‡æ–°è®¡æ•°ï¼‰
      for (const k in counters) {
        if (parseInt(k) > level) delete counters[k];
      }
      if (!PREFIX_RE.test(trimmed)) return line; // éç¼–å·è¡Œä¿æŒä¸å˜
      const content = lineContent(line);
      counters[level] = (counters[level] || 0) + 1;
      const n = counters[level];
      let pre;
      if (level === 1) pre = `${n}. `;
      else if (level === 2) pre = `${String.fromCharCode(96 + n)}. `;
      else pre = "- ";
      return INDENT.repeat(level) + pre + content;
    }).join("\n");
  }

  // åº”ç”¨æ–°æ–‡æœ¬ + å…¨å±€é‡æ–°ç¼–å·ï¼Œå…‰æ ‡å®šä½åˆ°æŒ‡å®šè¡Œè¡Œé¦–çš„æ­£æ–‡èµ·å§‹å¤„
  function applyRenumbered(ta, newVal, cursorPos) {
    // è®¡ç®—å…‰æ ‡æ‰€åœ¨è¡Œç´¢å¼•ï¼ˆåœ¨ newVal ä¸­ï¼‰
    const lineIdx = (newVal.slice(0, cursorPos).match(/\n/g) || []).length;
    const renumbered = renumberAll(newVal);
    const newLines   = renumbered.split("\n");
    // é‡æ–°è®¡ç®—å…‰æ ‡ï¼šå®šä½åˆ°è¯¥è¡Œæ­£æ–‡èµ·å§‹ï¼ˆindent + prefix ä¹‹åï¼‰
    let pos = 0;
    for (let i = 0; i < lineIdx && i < newLines.length; i++) {
      pos += newLines[i].length + 1; // +1 æ¢è¡Œç¬¦
    }
    const tLine   = newLines[Math.min(lineIdx, newLines.length - 1)] || "";
    const tTrimmed = tLine.trimStart();
    const prefixLen = tLine.length - tTrimmed.length + (tTrimmed.match(PREFIX_RE) || [""])[0].length;
    pos += prefixLen;
    ta.value = renumbered;
    ta.setSelectionRange(pos, pos);
    charCount.textContent = `${renumbered.length} å­—`;
  }

  // ä¸´æ—¶å‰ç¼€ï¼ˆç”¨äºåœ¨ renumberAll ä¿®æ­£å‰å ä½ï¼‰
  function provPrefix(level) {
    if (level === 1) return "1. ";
    if (level === 2) return "a. ";
    if (level >= 3) return "- ";
    return "";
  }

  // ä¿®æ”¹å½“å‰è¡Œçš„å±‚çº§ï¼ˆTab / Shift+Tabï¼‰
  function shiftLineLevel(ta, delta) {
    const val   = ta.value;
    const start = ta.selectionStart;
    const lineStart  = val.lastIndexOf("\n", start - 1) + 1;
    const lineEndIdx = val.indexOf("\n", start);
    const lineStop   = lineEndIdx === -1 ? val.length : lineEndIdx;
    const line       = val.slice(lineStart, lineStop);
    const newLevel   = Math.max(0, lineLevel(line) + delta);
    const content    = lineContent(line);
    const newLine    = INDENT.repeat(newLevel) + provPrefix(newLevel) + content;
    const newVal     = val.slice(0, lineStart) + newLine + val.slice(lineStop);
    // å…‰æ ‡å®šä½åˆ°æ–°è¡Œæ­£æ–‡èµ·å§‹ï¼ˆrenumberAll ä¼šä¿®æ­£å‰ç¼€ï¼ŒapplyRenumbered é‡æ–°è®¡ç®—ï¼‰
    const cursorPos  = lineStart + newLine.length - content.length;
    applyRenumbered(ta, newVal, cursorPos);
  }

  noteInput.addEventListener("keydown", (e) => {
    const ta    = noteInput;
    const start = ta.selectionStart;
    const end   = ta.selectionEnd;
    const val   = ta.value;

    // Shift+Tabï¼šå‡ä¸€çº§
    if (e.key === "Tab" && e.shiftKey) {
      e.preventDefault();
      shiftLineLevel(ta, -1);
      return;
    }

    // Tabï¼šé™ä¸€çº§
    if (e.key === "Tab" && !e.shiftKey) {
      e.preventDefault();
      if (start === end) {
        shiftLineLevel(ta, +1);
      } else {
        // å¤šé€‰æ—¶åªåŠ ç¼©è¿›ï¼Œä¸æ”¹ç¼–å·
        ta.value = val.slice(0, start) + INDENT + val.slice(start);
        ta.setSelectionRange(start + INDENT.length, end + INDENT.length);
        charCount.textContent = `${ta.value.length} å­—`;
      }
      return;
    }

    // Enterï¼šæœ‰ç¼–å·æ—¶ç»§ç»­åŒçº§ç¼–å·
    if (e.key === "Enter") {
      const lineStart  = val.lastIndexOf("\n", start - 1) + 1;
      const lineEndIdx = val.indexOf("\n", start);
      const lineStop   = lineEndIdx === -1 ? val.length : lineEndIdx;
      const line       = val.slice(lineStart, lineStop);
      const level      = lineLevel(line);
      if (level > 0 && PREFIX_RE.test(line.trimStart())) {
        e.preventDefault();
        const content = lineContent(line);
        if (content.trim() === "") {
          // ç©ºæ¡ç›®ï¼šä¸Šå‡ä¸€çº§ï¼ˆlevel 1 æ—¶å½»åº•é€€å‡ºåˆ—è¡¨ï¼‰
          const upLevel = Math.max(0, level - 1);
          const newLine = INDENT.repeat(upLevel) + provPrefix(upLevel);
          const newVal  = val.slice(0, lineStart) + newLine + val.slice(lineStop);
          applyRenumbered(ta, newVal, lineStart + newLine.length);
        } else {
          // æ’å…¥ä¸‹ä¸€ä¸ªåŒçº§å ä½æ¡ç›®ï¼ŒrenumberAll ä¼šä¿®æ­£åºå·
          const insertion = "\n" + INDENT.repeat(level) + provPrefix(level);
          const newVal    = val.slice(0, start) + insertion + val.slice(start);
          applyRenumbered(ta, newVal, start + insertion.length);
        }
        return;
      }
    }

    // Backspaceï¼šæœ‰ä¸¤ç§æƒ…å†µ
    if (e.key === "Backspace" && start === end) {
      const lineStart    = val.lastIndexOf("\n", start - 1) + 1;
      const lineEndIdx   = val.indexOf("\n", start);
      const lineStop     = lineEndIdx === -1 ? val.length : lineEndIdx;
      const line         = val.slice(lineStart, lineStop);
      const beforeCursor = val.slice(lineStart, start);
      const indentLen    = lineLevel(line) * INDENT.length;
      const prefixMatch  = line.trimStart().match(PREFIX_RE);

      // æƒ…å†µAï¼šå…‰æ ‡æ°åœ¨ç¼–å·å‰ç¼€æœ«å°¾ï¼ˆindent + prefix ä¹‹åï¼Œå†…å®¹ä¹‹å‰ï¼‰
      //        â†’ ä»…åˆ é™¤ç¼–å·å‰ç¼€ï¼Œä¿ç•™ç¼©è¿›å’Œæ­£æ–‡å†…å®¹ï¼Œç„¶åé‡æ–°ç¼–å·
      if (prefixMatch && start === lineStart + indentLen + prefixMatch[0].length) {
        e.preventDefault();
        // å»æ‰å½“å‰è¡Œçš„ prefixï¼ˆä¿ç•™ç¼©è¿› + æ­£æ–‡ï¼‰
        const prefixLen  = prefixMatch[0].length;
        const newVal     = val.slice(0, lineStart + indentLen) + val.slice(lineStart + indentLen + prefixLen);
        const newCursorPos = lineStart + indentLen; // å…‰æ ‡åœåœ¨ï¼ˆç¼©è¿›ä¹‹åã€åŸæ­£æ–‡èµ·ç‚¹ï¼‰
        applyRenumbered(ta, newVal, newCursorPos);
        return;
      }

      // æƒ…å†µBï¼šå…‰æ ‡å‰å…¨æ˜¯ç¼©è¿›ç©ºæ ¼æ—¶å›é€€ä¸€çº§
      if (/^\s+$/.test(beforeCursor) && beforeCursor.length >= INDENT.length) {
        e.preventDefault();
        ta.value = val.slice(0, start - INDENT.length) + val.slice(start);
        ta.setSelectionRange(start - INDENT.length, start - INDENT.length);
        charCount.textContent = `${ta.value.length} å­—`;
      }
    }
  });

  todayBtn.addEventListener("click", () => {
    dateInput.value = getTodayStr();
  });

  clearAllBtn.addEventListener("click", () => {
    if (notes.length === 0) return;
    showConfirm(
      "ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¬”è®°å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œæ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚",
      () => {
        notes = [];
        saveNotes();
        activeTag = null;
        render();
      },
      { okText: "æ¸…ç©ºå…¨éƒ¨", icon: "âš ï¸" }
    );
  });

  // --- é¢æ¿æ‹–æ‹½è°ƒèŠ‚ ---
  const resizeHandle = document.getElementById("resizeHandle");
  const paneLeft = document.getElementById("paneLeft");
  const paneRight = document.getElementById("paneRight");
  const mainEl = document.querySelector("main");

  let isResizing = false;
  let resizeStartX = 0;
  let resizeStartLeftWidth = 0;
  let resizeStartRightWidth = 0;

  resizeHandle.addEventListener("mousedown", (e) => {
    e.preventDefault();
    isResizing = true;
    resizeStartX = e.clientX;
    resizeStartLeftWidth = paneLeft.offsetWidth;
    resizeStartRightWidth = paneRight.offsetWidth;
    resizeHandle.classList.add("dragging");
    document.body.style.cursor = "col-resize";
    document.body.style.userSelect = "none";
  });

  document.addEventListener("mousemove", (e) => {
    if (!isResizing) return;
    const dx = e.clientX - resizeStartX;
    // ä¸ CSS min-width ä¿æŒä¸€è‡´ï¼Œé˜²æ­¢ h2 æ ‡é¢˜è¡Œæ¢è¡Œ
    const minLeft  = 310;
    const minRight = 250;
    const totalWidth = resizeStartLeftWidth + resizeStartRightWidth;
    const maxLeft = totalWidth - minRight;
    let newLeft  = Math.max(minLeft, Math.min(maxLeft, resizeStartLeftWidth + dx));
    let newRight = totalWidth - newLeft;
    paneLeft.style.flex  = "none";
    paneRight.style.flex = "none";
    paneLeft.style.width  = newLeft  + "px";
    paneRight.style.width = newRight + "px";
  });

  document.addEventListener("mouseup", () => {
    if (!isResizing) return;
    isResizing = false;
    resizeHandle.classList.remove("dragging");
    document.body.style.cursor = "";
    document.body.style.userSelect = "";
  });

  // --- åˆå§‹åŒ– ---
  async function init() {
    dateInput.value = getTodayStr();

    window.addEventListener("online",  () => setSyncBadge("online"));
    window.addEventListener("offline", () => setSyncBadge("offline"));

    // ç™»å½•ï¼šä¼˜å…ˆç”¨æˆ·åå¯†ç ï¼Œå¤±è´¥åˆ™é™çº§åŒ¿åç™»å½•ï¼ˆä½¿ç”¨ 2.24+ signInWithPassword / signInAnonymouslyï¼‰
    try {
      const { data: sessionData } = await tcbAuth.getSession();
      if (!sessionData?.session) {
        const { error: pwdErr } = await tcbAuth.signInWithPassword({
          username: "default",
          password: "Default1234"
        });
        if (pwdErr) {
          console.warn("[Auth] ç”¨æˆ·åå¯†ç ç™»å½•å¤±è´¥ï¼Œå°è¯•åŒ¿åç™»å½•ï¼š", pwdErr);
          const { error: anonErr } = await tcbAuth.signInAnonymously();
          if (anonErr) throw anonErr;
          console.log("[Auth] åŒ¿åç™»å½•æˆåŠŸ");
        } else {
          console.log("[Auth] ç™»å½•æˆåŠŸ username: default");
        }
      } else {
        const u = sessionData.session.user;
        const display = u?.user_metadata?.username || u?.user_metadata?.nickName || u?.email || u?.phone || u?.id || "anonymous";
        console.log("[Auth] å·²æœ‰ä¼šè¯ï¼Œå½“å‰ç”¨æˆ·ï¼š", display);
      }
    } catch (e) {
      console.warn("[Auth] TCB ç™»å½•å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼ï¼š", e);
      loadNotesFromLocal();
      render();
      return;
    }

    // ä»äº‘å­˜å‚¨è¯»å–ç¬”è®°ï¼Œä¸æœ¬åœ°åˆå¹¶åå†å†™å›ï¼ˆé¿å…ç›´æ¥è¦†ç›–å¯¼è‡´å¤šç«¯ä¸¢æ•°æ®ï¼‰
    loadNotesFromLocal();
    const localBeforeMerge = notes.length ? notes.slice() : [];

    // ä¼˜å…ˆä½¿ç”¨ä¸Šæ¬¡ä¸Šä¼ æ—¶ SDK è¿”å›å¹¶æŒä¹…åŒ–çš„çœŸå® fileIDï¼Œå¦åˆ™ç”¨ç¡¬ç¼–ç çš„å…œåº•å€¼
    const savedFileId = localStorage.getItem(FILE_ID_KEY) || CLOUD_FILE_ID_DEFAULT;
    console.log("[Storage] ä½¿ç”¨ fileID:", savedFileId,
      localStorage.getItem(FILE_ID_KEY) ? "(æ¥è‡ªç¼“å­˜)" : "(æ¥è‡ªé»˜è®¤å€¼ï¼Œæ¸…é™¤å­˜å‚¨åé¦–æ¬¡åŠ è½½)");

    try {
      // fileList å¿…é¡»æ˜¯å­—ç¬¦ä¸²æ•°ç»„ï¼ˆfileIDï¼‰ï¼Œä¸èƒ½æ˜¯å¯¹è±¡â€”â€”å®˜æ–¹ JS SDK æ–‡æ¡£è§„èŒƒ
      const res = await tcbApp.getTempFileURL({
        fileList: [savedFileId]
      });
      const item = res.fileList[0];
      if (item.code === "SUCCESS" && item.tempFileURL) {
        // ä¸´æ—¶é“¾æ¥è·å–æˆåŠŸï¼Œå°†å½“å‰ä½¿ç”¨çš„ fileID å†™å…¥ç¼“å­˜ï¼ˆå…œåº•é»˜è®¤å€¼ä¹Ÿä¸€å¹¶æŒä¹…åŒ–ï¼‰
        localStorage.setItem(FILE_ID_KEY, savedFileId);
        // æ‹¼æ¥æ—¶é—´æˆ³ç ´å CDN ç¼“å­˜ï¼Œä¿è¯è¯»åˆ°çš„æ˜¯æœ€æ–°ä¸Šä¼ çš„æ–‡ä»¶
        const freshUrl = item.tempFileURL + (item.tempFileURL.includes("?") ? "&" : "?") + "_t=" + Date.now();
        const resp = await fetch(freshUrl, { cache: "no-store" });
        if (resp.ok) {
          const data = await resp.json();
          const cloudNotes = Array.isArray(data) ? data : [];
          console.log(`[Storage] äº‘ç«¯ notebook.json è¯»å–æˆåŠŸï¼Œæ¡ç›®æ•°ï¼š${cloudNotes.length}`);
          notes = mergeNotes(cloudNotes, localBeforeMerge);
          console.log(`[Storage] åˆå¹¶åæ¡ç›®æ•°ï¼š${notes.length}ï¼ˆæœ¬åœ° ${localBeforeMerge.length} + äº‘ç«¯ ${cloudNotes.length}ï¼‰`);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
          setSyncBadge("online");
          // è‹¥åˆå¹¶ç»“æœä¸äº‘ç«¯ä¸ä¸€è‡´ï¼Œä¸Šä¼ åˆå¹¶åçš„å®Œæ•´æ•°æ®ï¼Œä¿è¯äº‘ä¸Šä¹Ÿæ˜¯æœ€æ–°åˆå¹¶ç‰ˆ
          if (JSON.stringify(cloudNotes) !== JSON.stringify(notes)) {
            console.log("[Storage] äº‘ç«¯ä¸æœ¬åœ°æœ‰å·®å¼‚ï¼Œå›å†™åˆå¹¶ç»“æœåˆ°äº‘å­˜å‚¨â€¦");
            try {
              const blob = new Blob([JSON.stringify(notes)], { type: "application/json" });
              const file = new File([blob], "notebook.json", { type: "application/json" });
              const uploadRes = await tcbApp.uploadFile({ cloudPath: CLOUD_PATH, filePath: file });
              if (uploadRes?.fileID) localStorage.setItem(FILE_ID_KEY, uploadRes.fileID);
              console.log("[Storage] å›å†™å®Œæˆ");
            } catch (e) { console.warn("[Storage] åˆå¹¶åå›å†™äº‘å­˜å‚¨å¤±è´¥ï¼š", e); }
          }
        } else {
          console.warn("[Storage] äº‘ç«¯æ–‡ä»¶è¯·æ±‚å¤±è´¥ï¼ŒHTTP:", resp.status);
        }
      } else if (item.code === "STORAGE_FILE_NONEXIST") {
        // æ–‡ä»¶åœ¨äº‘ç«¯ç¡®å®ä¸å­˜åœ¨ï¼ˆçœŸæ­£é¦–æ¬¡ / æ–‡ä»¶è¢«æ‰‹åŠ¨åˆ é™¤ï¼‰ï¼Œä»…ä½¿ç”¨æœ¬åœ°æ•°æ®ï¼Œä¸è¦†ç›–äº‘ç«¯
        // å¾…ç”¨æˆ·ä¿å­˜ç¬”è®°æ—¶ä¼šè§¦å‘ uploadFile è‡ªåŠ¨åˆ›å»ºæ–‡ä»¶
        console.log("[Storage] äº‘ç«¯æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®ï¼ˆä¿å­˜ç¬”è®°åå°†è‡ªåŠ¨åˆ›å»ºäº‘ç«¯æ–‡ä»¶ï¼‰");
        setSyncBadge("offline");
      } else {
        console.warn("[Storage] è·å–ä¸´æ—¶é“¾æ¥å¤±è´¥ï¼š", item);
      }
    } catch (err) {
      console.warn("[Storage] äº‘å­˜å‚¨è¯»å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®ï¼š", err);
      setSyncBadge("offline");
    }
    render();
  }

  // â”€â”€ æ›´æ–°æ—¥å¿—æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // type: featï¼ˆæ–°åŠŸèƒ½ï¼‰| fixï¼ˆä¿®å¤ï¼‰| infraï¼ˆåŸºç¡€è®¾æ–½/éƒ¨ç½²ï¼‰
  const CHANGELOG = [
    {
      version: "v0.2.4",
      date: "2026-02-27",
      type: "feat",
      desc: "ç»Ÿä¸€ç¡®è®¤å¼¹çª—ï¼›åˆ é™¤ç¬”è®°å¢åŠ ç¡®è®¤",
      items: [
        "æ–°å¢ç»Ÿä¸€é£æ ¼çš„ã€Œç¡®è®¤æç¤ºã€å¼¹çª—ï¼Œæ›¿æ¢æ‰€æœ‰æµè§ˆå™¨åŸç”Ÿ confirm å¼¹æ¡†ï¼Œè§†è§‰ä¸åº”ç”¨æ•´ä½“é£æ ¼ä¸€è‡´",
        "åˆ é™¤å•æ¡ç¬”è®°æ—¶ï¼Œä¹Ÿä¼šå¼¹å‡ºç¡®è®¤æç¤ºï¼Œé˜²æ­¢è¯¯åˆ ",
        "å…¨å±€åˆ é™¤æ ‡ç­¾ã€ç¬”è®°å†…åˆ é™¤æ ‡ç­¾ã€æ¸…ç©ºæ‰€æœ‰ç¬”è®°å‡ä½¿ç”¨åŒä¸€å¥—ç¡®è®¤å¼¹çª—",
        "å¼¹çª—æ”¯æŒç‚¹å‡»é®ç½©æˆ–æŒ‰ Esc å–æ¶ˆ"
      ]
    },
    {
      version: "v0.2.3",
      date: "2026-02-27",
      type: "feat",
      desc: "æ›´æ–°æ—¥å¿—ä¿ç•™å†…å®¹ï¼›tag åˆ é™¤ç¡®è®¤ï¼›ç¬”è®°å†… tag ç‹¬ç«‹åˆ é™¤",
      items: [
        "æ›´æ–°å·²æœ‰ç¬”è®°åï¼Œå·¦ä¾§ç¼–è¾‘åŒºä¸å†è‡ªåŠ¨æ¸…ç©ºï¼Œæ–¹ä¾¿ç»§ç»­ä¿®æ”¹",
        "åœ¨æ ‡ç­¾æ å³é”®é€‰æ‹©ã€Œåˆ é™¤æ ‡ç­¾ï¼ˆæ‰€æœ‰ç¬”è®°ï¼‰ã€æ—¶ï¼Œä¼šå…ˆå¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†ï¼Œé˜²æ­¢è¯¯æ“ä½œ",
        "ç¬”è®°å¡ç‰‡å†…çš„ tag å³é”®èœå•ç‹¬ç«‹ï¼šé€‰æ‹©ã€Œä»æœ¬æ¡ç¬”è®°ä¸­åˆ é™¤ã€ä»…åˆ é™¤å½“å‰ç¬”è®°çš„æ ‡ç­¾ï¼Œä¸å½±å“å…¶ä»–ç¬”è®°ï¼ŒåŒæ ·æœ‰ç¡®è®¤æç¤º"
      ]
    },
    {
      version: "v0.2.2",
      date: "2026-02-27",
      type: "feat",
      desc: "æŒ‰é’®é£æ ¼ç»Ÿä¸€ + tag å³é”®èœå•",
      items: [
        "ç»Ÿä¸€å…¨å±€æŒ‰é’®äº¤äº’è§„èŒƒï¼šhover æ—¶åªæ”¹è¾¹æ¡†å’Œæ–‡å­—é¢œè‰²ï¼Œä¸æ”¹å˜èƒŒæ™¯è‰²ï¼ˆä¸ã€Œæ›´æ–°è®°å½•ã€æŒ‰é’®ä¿æŒä¸€è‡´ï¼‰",
        "æ ‡ç­¾ï¼ˆtag chipï¼‰åŒæ­¥åŠ å…¥ hover/active åŠ¨æ•ˆï¼Œé£æ ¼ä¸æŒ‰é’®ç»Ÿä¸€",
        "tag å³é”®ç‚¹å‡»ä» confirm å¼¹çª—æ”¹ä¸ºæµ®åŠ¨èœå•ï¼Œèœå•åŒ…å«ã€Œç­›é€‰æ­¤æ ‡ç­¾ã€å’Œã€Œåˆ é™¤æ ‡ç­¾ã€ä¸¤é¡¹ï¼Œä¸ç¬”è®°å³é”®èœå•ä½“éªŒä¸€è‡´",
        "ç­›é€‰çŠ¶æ€ä¸‹å³é”® tagï¼Œèœå•ç¬¬ä¸€é¡¹è‡ªåŠ¨æ˜¾ç¤ºã€Œå–æ¶ˆç­›é€‰ã€"
      ]
    },
    {
      version: "v0.2.1",
      date: "2026-02-27",
      type: "feat",
      desc: "å…¨å±€æŒ‰é’®ç»Ÿä¸€ hover / active äº¤äº’æ•ˆæœ",
      items: [
        "æ‰€æœ‰æŒ‰é’®æ–°å¢ hover é«˜äº®ï¼šä¸»è‰²æŒ‰é’®æ‚¬åœå˜æ·±å¹¶å¸¦é˜´å½±ï¼Œè¾¹æ¡†æŒ‰é’®æ‚¬åœå˜ä¸»è‰²è°ƒ",
        "æ–°å¢ active æŒ‰ä¸‹åé¦ˆï¼ˆè½»å¾®é€æ˜åº¦å˜åŒ–ï¼‰ï¼Œæå‡ç‚¹å‡»æ„Ÿ",
        "è¿‡æ¸¡åŠ¨ç”»ç»Ÿä¸€ä¸º 0.15sï¼Œä¸ã€Œæ›´æ–°è®°å½•ã€æŒ‰é’®é£æ ¼ä¸€è‡´"
      ]
    },
    {
      version: "v0.2.0",
      date: "2026-02-27",
      type: "feat",
      desc: "å…¨å±å¸ƒå±€é‡æ„ï¼šä¸¤ä¾§é¢æ¿è´´åº•ã€ç¬”è®°ç‹¬ç«‹æ»šåŠ¨",
      items: [
        "æ•´ä½“å¸ƒå±€æ”¹ä¸º 100vh å…¨å±ï¼Œå»æ‰é¡µé¢çº§åˆ«çš„çºµå‘æ»šåŠ¨æ¡",
        "å·¦å³ä¸¤ä¾§é¢æ¿é«˜åº¦ç´§è´´æµè§ˆå™¨åº•éƒ¨ï¼Œä¸å†äº§ç”Ÿé¡µé¢æº¢å‡º",
        "å·¦ä¾§æ–‡æœ¬æ¡†è‡ªåŠ¨æ’‘æ»¡å‰©ä½™é«˜åº¦ï¼Œç§»é™¤æ‰‹åŠ¨æ‹–æ‹½è°ƒæ•´æ–‡æœ¬æ¡†å¤§å°",
        "å³ä¾§ç¬”è®°åˆ—è¡¨åŒºåŸŸå•ç‹¬æ»šåŠ¨ï¼Œæ ‡ç­¾åŒºåŸŸå›ºå®šä¸åŠ¨",
        "ä¸­é—´æ‹–æ‹½åˆ†éš”æ¡é™åˆ¶æœ€å°å®½åº¦ï¼ˆå·¦ 310px / å³ 250pxï¼‰ï¼Œé˜²æ­¢æ ‡é¢˜æ–‡å­—æ¢è¡Œ"
      ]
    },
    {
      version: "v0.1.9",
      date: "2026-02-27",
      type: "fix",
      desc: "Backspace åˆ é™¤ç¼–å·å‰ç¼€æ”¹ä¸ºåªç§»é™¤å‰ç¼€ï¼Œä¿ç•™æ­£æ–‡",
      items: [
        "åœ¨ç¼–å·å‰ç¼€æœ«å°¾ï¼ˆå…‰æ ‡ç´§è´´æ­£æ–‡èµ·ç‚¹ï¼‰æŒ‰ Backspaceï¼Œåªåˆ é™¤ ã€Œ1. ã€ã€Œa. ã€ã€Œ- ã€ç­‰å‰ç¼€ï¼Œæ­£æ–‡å†…å®¹ç•™åœ¨åŸè¡Œ",
        "åˆ é™¤å‰ç¼€åè‡ªåŠ¨é‡æ–°ç¼–å·ï¼Œåç»­åºå·è¿ç»­æ›´æ–°"
      ]
    },
    {
      version: "v0.1.8",
      date: "2026-02-27",
      type: "feat",
      desc: "ç¬”è®°å¡ç‰‡ 5 è¡Œæˆªæ–­ + Backspace åˆ è¡Œé‡ç¼–å·",
      items: [
        "ç¬”è®°åˆ—è¡¨å¡ç‰‡ï¼šæ­£æ–‡è¶…è¿‡ 5 è¡Œæ—¶ï¼Œç¬¬ 5 è¡Œè‡ªåŠ¨æ˜¾ç¤ºã€Œâ€¦ã€çœç•¥ï¼Œä¿æŒåˆ—è¡¨æ•´æ´",
        "ç¼–å·æ¨¡å¼ä¸‹ï¼Œå…‰æ ‡åœ¨ç¼–å·å‰ç¼€æœ«å°¾ï¼ˆå†…å®¹èµ·ç‚¹ï¼‰æŒ‰ Backspaceï¼Œç›´æ¥åˆ é™¤æ•´è¡Œå¹¶è‡ªåŠ¨é‡æ–°ç¼–å·",
        "ä¿®å¤äº†åˆ é™¤ç¼–å·ååºå·ä¸è¿ç»­çš„é—®é¢˜ï¼ˆå¦‚åˆ é™¤ç¬¬ 2 æ¡åï¼Œåç»­æ¡ç›®ä»æ˜¾ç¤º 3ã€4ï¼Œç°åœ¨ä¼šé‡æ’ä¸º 2ã€3ï¼‰"
      ]
    },
    {
      version: "v0.1.7",
      date: "2026-02-27",
      type: "feat",
      desc: "æ–°å¢ç‰ˆæœ¬æ›´æ–°è®°å½•é¢æ¿",
      items: [
        "å³ä¸Šè§’æ–°å¢ã€Œæ›´æ–°è®°å½•ã€æŒ‰é’®ï¼Œç‚¹å‡»æ»‘å‡ºä¾§è¾¹æŠ½å±‰",
        "ä»¥æ—¶é—´çº¿å½¢å¼å±•ç¤ºæ¯ä¸ªç‰ˆæœ¬çš„è¯¦ç»†æ”¹åŠ¨",
        "AI è§„åˆ™ä¸­åŠ å…¥ç»´æŠ¤æ›´æ–°æ—¥å¿—çš„è¦æ±‚ï¼Œç¡®ä¿æ¯æ¬¡åŠŸèƒ½æ”¹åŠ¨éƒ½æœ‰è®°å½•"
      ]
    },
    {
      version: "v0.1.6",
      date: "2026-02-27",
      type: "fix",
      desc: "ä¿®å¤å…¨å±€ç¼–å·é‡æ–°ç¼–æ’ä¸å±‚çº§ç»­ç¼–",
      items: [
        "å…¨å±€é‡æ–°ç¼–å·ï¼Œè§£å†³å¤¹å±‚å­çº§ååŒçº§åºå·æ–­ç»­é—®é¢˜",
        "åŒå±‚çº§åºå·ç°åœ¨å¯ä»¥æ­£ç¡®è·¨è¶Šå­èŠ‚ç‚¹ç»§ç»­è®¡æ•°"
      ]
    },
    {
      version: "v0.1.5",
      date: "2026-02-27",
      type: "fix",
      desc: "Enter/Tab ç¼–å·ä½“éªŒä¼˜åŒ–",
      items: [
        "Enter é”®åœ¨åˆ—è¡¨é¡¹æœ«å°¾å¯è‡ªåŠ¨ç»§ç»­åŒçº§ç¼–å·",
        "Tab ä»æ­£ç¡®åºå·ç»­ç¼–ï¼Œä¸å†ä» 1 é‡æ–°å¼€å§‹",
        "ä¿®å¤ countSiblings ç²¾ç¡®è®¡å±‚çº§çš„ bug"
      ]
    },
    {
      version: "v0.1.4",
      date: "2026-02-27",
      type: "feat",
      desc: "Shift+Tab å‡çº§ä¸ç¼–å·è§„åˆ™æ”¹è¿›",
      items: [
        "Shift+Tab å¯å°†åˆ—è¡¨é¡¹å‡çº§åˆ°ä¸Šä¸€å±‚çº§",
        "Tab æ›¿æ¢ç¼–å·è€Œéå åŠ ï¼Œé¿å… 1.1.1 æ ¼å¼é”™ä¹±",
        "æ–°å¢ç‰ˆæœ¬å·è‡ªåŠ¨é€’å¢ Cursor è§„åˆ™"
      ]
    },
    {
      version: "v1.0.3",
      date: "2026-02-27",
      type: "feat",
      desc: "Tab ç¼©è¿›è‡ªåŠ¨ç¼–å·ä¸ Backspace å›é€€",
      items: [
        "ç¼–è¾‘å™¨æ”¯æŒ Tab ç¼©è¿›å¹¶è‡ªåŠ¨è¡¥å…¨æœ‰åºç¼–å·",
        "Backspace åœ¨è¡Œé¦–å¯å›é€€ç¼©è¿›å±‚çº§",
        "å–æ¶ˆè‡ªåŠ¨ä»æ–‡æœ¬æå–è‹±æ–‡å…³é”®è¯ä¸º tagï¼ˆé¿å…å™ªå£°ï¼‰"
      ]
    },
    {
      version: "v0.1.2",
      date: "2026-02-27",
      type: "feat",
      desc: "ç¬”è®°å·¦é”®åŠ è½½åˆ°ç¼–è¾‘å™¨æ”¯æŒç¼–è¾‘",
      items: [
        "å·¦é”®ç‚¹å‡»ç¬”è®°å¡ç‰‡ï¼Œå†…å®¹è‡ªåŠ¨åŠ è½½å›ç¼–è¾‘åŒº",
        "æ”¯æŒä¿®æ”¹å·²æœ‰ç¬”è®°å¹¶æ›´æ–°ä¿å­˜"
      ]
    },
    {
      version: "v0.2.0",
      date: "2026-02-27",
      type: "feat",
      desc: "å³é”®åˆ é™¤ç¬”è®°ï¼›æ— æ ‡é¢˜è‡ªåŠ¨å–é¦–è¡Œ",
      items: [
        "ç¬”è®°å¡ç‰‡å³é”®èœå•æ–°å¢åˆ é™¤åŠŸèƒ½",
        "æœªå¡«å†™æ ‡é¢˜æ—¶è‡ªåŠ¨æˆªå–æ­£æ–‡é¦–è¡Œå‰ 5 å­—ä½œä¸ºæ ‡é¢˜"
      ]
    },
    {
      version: "v0.1.0",
      date: "2026-02-27",
      type: "feat",
      desc: "ç‰ˆæœ¬å·æ˜¾ç¤ºï¼›æ ‡é¢˜åŠŸèƒ½ä¸Šçº¿",
      items: [
        "å·¦ä¸Šè§’ header æ–°å¢ç‰ˆæœ¬å·å±•ç¤º",
        "ç¬”è®°æ”¯æŒå•ç‹¬å¡«å†™æ ‡é¢˜å­—æ®µ",
        "æ—¶é—´æ˜¾ç¤ºç§»åˆ°å³ä¸‹è§’ï¼Œç²¾ç¡®åˆ°åˆ†é’Ÿ"
      ]
    },
    {
      version: "äº‘å­˜å‚¨é‡æ„",
      date: "2026-02-26",
      type: "infra",
      desc: "å­˜å‚¨å±‚ä» NoSQL æ•°æ®åº“åˆ‡æ¢ä¸ºäº‘å­˜å‚¨ JSON æ–‡ä»¶",
      items: [
        "æ‰€æœ‰ç¬”è®°åºåˆ—åŒ–ä¸º notebook.json ä¸Šä¼ è‡³äº‘å­˜å‚¨",
        "ä¿®å¤ CloudBase è®¤è¯ APIï¼ˆå‡çº§ SDK åˆ° 2.24+ï¼Œæ”¹ç”¨ signInWithPasswordï¼‰",
        "ä¿®æ­£ getTempFileURL å‚æ•°æ ¼å¼ï¼Œæ·»åŠ  CDN ç¼“å­˜ç ´åæ—¶é—´æˆ³",
        "åŒæ­¥é€»è¾‘æ”¹ä¸ºåˆå¹¶æ¨¡å¼ï¼Œé¿å…å¤šç«¯ç›´æ¥è¦†ç›–å¯¼è‡´æ•°æ®ä¸¢å¤±",
        "ä¿®å¤ fileID bucket åï¼ˆè¡¥å…¨ 6b74- å‰ç¼€ï¼‰ï¼Œè§£å†³è·å–ä¸´æ—¶é“¾æ¥å¤±è´¥",
        "ä½¿ç”¨ uploadFile è¿”å›çš„çœŸå® fileID æ›¿ä»£æ‰‹åŠ¨æ‹¼æ¥"
      ]
    },
    {
      version: "v1.0.0",
      date: "2026-02-25",
      type: "infra",
      desc: "åˆå§‹ç‰ˆæœ¬ä¸Šçº¿",
      items: [
        "åŸºäºè…¾è®¯äº‘ CloudBase é™æ€æ‰˜ç®¡éƒ¨ç½²",
        "ç¬”è®°å¢åˆ ã€æ ‡ç­¾æå–ã€æ—¥æœŸç­›é€‰æ ¸å¿ƒåŠŸèƒ½",
        "æ”¯æŒåŒ¿åç™»å½•ä¸ç”¨æˆ·åå¯†ç ç™»å½•åŒæ¨¡å¼"
      ]
    }
  ];

  // â”€â”€ æ¸²æŸ“æ›´æ–°æ—¥å¿— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderChangelog() {
    const body = document.getElementById("changelogBody");
    body.innerHTML = "";
    CHANGELOG.forEach((entry, idx) => {
      const isLast = idx === CHANGELOG.length - 1;
      const dotClass = entry.type === "fix" ? "cl-dot fix"
        : entry.type === "infra" ? "cl-dot init"
        : "cl-dot";
      const tagHtml = `<span class="cl-tag ${entry.type}">${
        entry.type === "feat" ? "æ–°åŠŸèƒ½" : entry.type === "fix" ? "ä¿®å¤" : "åŸºç¡€è®¾æ–½"
      }</span>`;

      const el = document.createElement("div");
      el.className = "cl-entry";
      el.innerHTML = `
        <div class="cl-line">
          <div class="${dotClass}"></div>
          ${isLast ? "" : '<div class="cl-connector"></div>'}
        </div>
        <div class="cl-content">
          <div class="cl-version-row">
            <span class="cl-version">${entry.version}</span>
            <span class="cl-date">${entry.date}</span>
            ${tagHtml}
          </div>
          <div class="cl-desc">${entry.desc}</div>
          <ul class="cl-items">
            ${entry.items.map(i => `<li>${i}</li>`).join("")}
          </ul>
        </div>`;
      body.appendChild(el);
    });
  }

  // â”€â”€ æŠ½å±‰å¼€å…³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openChangelog() {
    renderChangelog();
    document.getElementById("changelogDrawer").classList.add("open");
    document.getElementById("changelogBackdrop").classList.add("open");
    document.body.style.overflow = "hidden";
  }
  function closeChangelog() {
    document.getElementById("changelogDrawer").classList.remove("open");
    document.getElementById("changelogBackdrop").classList.remove("open");
    document.body.style.overflow = "";
  }

  document.getElementById("changelogBtn").addEventListener("click", openChangelog);
  document.getElementById("changelogClose").addEventListener("click", closeChangelog);
  document.getElementById("changelogBackdrop").addEventListener("click", closeChangelog);
  document.addEventListener("keydown", e => { if (e.key === "Escape") closeChangelog(); });

  init();
</script>
</body>
</html>