<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å­¦ä¹ æ—¥å¿—ç¬”è®°æœ¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ““</text></svg>" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --primary: #4f46e5;
      --primary-soft: #eef2ff;
      --bg: #f4f4f5;
      --border: #e4e4e7;
      --text-main: #18181b;
      --text-sub: #71717a;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top left, #eef2ff 0, #f4f4f5 45%, #fafafa 100%);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    .app {
      max-width: 1200px;
      width: 100%;
      margin: 4vh auto;
      padding: 24px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    header h1 {
      font-size: 26px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header h1 span.logo-dot {
      width: 13px;
      height: 13px;
      border-radius: 999px;
      background: var(--primary);
      display: inline-block;
    }

    header .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    header label {
      font-size: 15px;
      color: var(--text-sub);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    input[type="date"] {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 15px;
      background: white;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    button.primary {
      background: var(--primary);
      color: white;
    }

    button.outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-sub);
    }

    button.small {
      padding: 5px 12px;
      font-size: 13px;
    }

    main {
      display: flex;
      gap: 0;
      align-items: stretch;
    }

    .pane-left,
    .pane-right {
      min-width: 200px;
      flex-shrink: 0;
      overflow: hidden;
    }

    .pane-left {
      flex: 1.2;
    }

    .pane-right {
      flex: 1;
    }

    .resize-handle {
      width: 14px;
      flex-shrink: 0;
      cursor: col-resize;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      user-select: none;
    }

    .resize-handle::after {
      content: '';
      width: 3px;
      height: 44px;
      background: var(--border);
      border-radius: 3px;
      transition: background 0.2s, transform 0.2s;
    }

    .resize-handle:hover::after,
    .resize-handle.dragging::after {
      background: var(--primary);
      transform: scaleX(1.5);
    }

    @media (max-width: 800px) {
      main {
        flex-direction: column;
      }

      .pane-left,
      .pane-right {
        width: 100% !important;
        flex: none !important;
      }

      .resize-handle {
        display: none;
      }
    }

    .card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      border: 1px solid rgba(228, 228, 231, 0.9);
      padding: 20px 22px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
      backdrop-filter: blur(12px);
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-main);
    }

    .card h2 span.sub {
      font-size: 14px;
      color: var(--text-sub);
      font-weight: normal;
    }

    textarea {
      width: 100%;
      min-height: 180px;
      resize: vertical;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      font-size: 16px;
      line-height: 1.6;
      font-family: inherit;
    }

    textarea:focus,
    input[type="date"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.2);
    }

    .card-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .hint {
      font-size: 13px;
      color: var(--text-sub);
    }

    .hint code {
      background: var(--bg);
      padding: 1px 5px;
      border-radius: 4px;
      font-size: 12px;
    }

    .section {
      margin-top: 12px;
    }

    .section-title {
      font-size: 14px;
      color: var(--text-sub);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .tags-container,
    .note-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag-chip {
      font-size: 13px;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      color: var(--text-sub);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .tag-chip.active {
      background: var(--primary-soft);
      border-color: var(--primary);
      color: var(--primary);
      font-weight: 500;
    }

    .tag-chip span.count {
      font-size: 12px;
      opacity: 0.7;
    }

    .note-list {
      margin-top: 6px;
      max-height: 460px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .note-item {
      border-radius: 12px;
      border: 1px solid #e4e4e7;
      padding: 10px 14px;
      margin-bottom: 10px;
      background: #fdfdfd;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .note-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--text-sub);
    }

    .note-date {
      font-weight: 500;
    }

    .note-body {
      font-size: 15px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .note-tags {
      margin-top: 2px;
    }

    .note-tags .tag-chip {
      cursor: pointer;
      border-radius: 999px;
      background: var(--primary-soft);
      border-color: transparent;
      color: var(--primary);
      font-size: 12px;
    }

    .note-empty {
      font-size: 14px;
      color: var(--text-sub);
      padding: 16px 4px;
      text-align: center;
    }

    .filter-info {
      font-size: 13px;
      color: var(--text-sub);
    }

    .danger-link {
      font-size: 12px;
      color: var(--danger);
      cursor: pointer;
      text-decoration: underline;
      opacity: 0.7;
    }

    .sync-badge {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
      white-space: nowrap;
    }
    .sync-online  { background: #f0fdf4; color: #16a34a; border-color: #86efac; }
    .sync-offline { background: #fafafa; color: var(--text-sub); border-color: var(--border); }
    .sync-syncing { background: #eff6ff; color: #2563eb; border-color: #93c5fd; }
    .sync-error   { background: #fef2f2; color: var(--danger); border-color: #fca5a5; }

    /* --- æ ‡ç­¾é€‰æ‹©å¼¹çª— --- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
      backdrop-filter: blur(5px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.15s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    .modal-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 24px 64px rgba(15, 23, 42, 0.18);
      width: 100%;
      max-width: 500px;
      padding: 26px 28px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      animation: slideUp 0.18s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(12px); opacity: 0; }
      to   { transform: translateY(0);    opacity: 1; }
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-main);
      margin: 0 0 4px;
    }

    .modal-preview {
      font-size: 13px;
      color: var(--text-sub);
      background: var(--bg);
      border-radius: 8px;
      padding: 8px 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.4;
    }

    .modal-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .modal-section-label {
      font-size: 12px;
      color: var(--text-sub);
      font-weight: 500;
    }

    .modal-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 30px;
    }

    .modal-tag {
      font-size: 13px;
      padding: 5px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      color: var(--text-sub);
      cursor: pointer;
      user-select: none;
      transition: background 0.12s, border-color 0.12s, color 0.12s;
    }

    .modal-tag.selected {
      background: var(--primary-soft);
      border-color: var(--primary);
      color: var(--primary);
      font-weight: 500;
    }

    .modal-tag.custom {
      background: #f0fdf4;
      border-color: #86efac;
      color: #16a34a;
    }

    .modal-tag.custom.selected {
      background: #dcfce7;
      border-color: #4ade80;
      color: #15803d;
    }

    .modal-custom-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .modal-custom-row input {
      flex: 1;
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .modal-custom-row input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.15);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding-top: 6px;
      border-top: 1px solid var(--border);
    }

    .modal-empty-hint {
      font-size: 12px;
      color: var(--text-sub);
      font-style: italic;
    }
  </style>
  <!-- è…¾è®¯äº‘å¼€å‘ Web SDK -->
  <!-- éœ€ 2.24+ æ‰æ”¯æŒ signInWithPassword / signInAnonymously ç­‰æ–°è®¤è¯ API -->
  <script src="https://static.cloudbase.net/cloudbase-js-sdk/latest/cloudbase.full.js"></script>
</head>
<body>
<div class="app">
  <header>
    <h1>
      <span class="logo-dot"></span>
      å­¦ä¹ æ—¥å¿— Â· ç¬”è®°æœ¬
    </h1>
    <div class="controls">
      <span id="syncBadge" class="sync-badge sync-offline">â—‹ è¿æ¥ä¸­â€¦</span>
      <label>
        æ—¥æœŸ
        <input id="dateInput" type="date" />
      </label>
      <button id="todayBtn" class="outline small">è·³åˆ°ä»Šå¤©</button>
    </div>
  </header>

  <main>
    <!-- å·¦ä¾§ï¼šå†™ç¬”è®° -->
    <section class="card pane-left" id="paneLeft">
      <h2>
        å†™ä»Šå¤©çš„å­¦ä¹ æ—¥å¿—
        <span class="sub" id="charCount">0 å­—</span>
      </h2>
      <textarea id="noteInput" placeholder="ä»Šå¤©å­¦äº†ä»€ä¹ˆï¼Ÿé‡åˆ°ä»€ä¹ˆé—®é¢˜ï¼Ÿç”¨è‡ªå·±çš„è¯æ€»ç»“ä¸€ä¸‹å§ï½&#10;Tips: è¾“å…¥ #æ ‡ç­¾ å½¢å¼çš„å…³é”®è¯ï¼Œä¼šè‡ªåŠ¨æˆä¸º tagï¼Œä¾‹å¦‚ï¼š#Unity #ç®—æ³• #é˜…è¯»"></textarea>
      <div class="card-footer">
        <div class="hint">
          è‡ªåŠ¨æå–æ ‡ç­¾è§„åˆ™ï¼š
          <code>#æ ‡ç­¾</code> +
          <code>è‹±æ–‡å…³é”®è¯</code>ï¼ˆæŒ‰å‡ºç°é¢‘ç‡æ’åºï¼‰ +
          <code>åŒ…å«å·²æœ‰æ ‡ç­¾æ–‡æœ¬</code>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="saveBtn" class="primary">ä¿å­˜æ—¥å¿—</button>
        </div>
      </div>
    </section>

    <div class="resize-handle" id="resizeHandle" title="æ‹–æ‹½è°ƒèŠ‚å®½åº¦"></div>

    <!-- å³ä¾§ï¼štag & ç¬”è®°åˆ—è¡¨ -->
    <section class="card pane-right" id="paneRight">
      <h2>
        ç¬”è®°ä¸æ ‡ç­¾
        <span class="sub" id="noteSummary">å…± 0 æ¡ç¬”è®°</span>
      </h2>

      <div class="section">
        <div class="section-title">
          <span>è‡ªåŠ¨æ ‡ç­¾ï¼ˆå·¦é”®ç­›é€‰ / å³é”®åˆ é™¤ï¼‰</span>
          <div class="filter-info" id="filterInfo">æœªç­›é€‰</div>
        </div>
        <div class="tags-container" id="tagList"></div>
      </div>

      <div class="section">
        <div class="section-title">
          <span>ç¬”è®°åˆ—è¡¨</span>
          <span class="danger-link" id="clearAllBtn">æ¸…ç©ºæ‰€æœ‰æ•°æ®</span>
        </div>
        <div class="note-list" id="noteList"></div>
      </div>
    </section>
  </main>
</div>

<!-- æ ‡ç­¾é€‰æ‹©å¼¹çª— -->
<div id="tagModal" class="modal-overlay" style="display:none;">
  <div class="modal-card">
    <div>
      <div class="modal-title">ç¡®è®¤æ ‡ç­¾</div>
      <div class="modal-preview" id="modalPreview"></div>
    </div>

    <div class="modal-section" id="modalAutoSection">
      <div class="modal-section-label">è‡ªåŠ¨æå–ï¼ˆå·²é¢„é€‰ï¼Œå¯å–æ¶ˆï¼‰</div>
      <div class="modal-tags" id="modalAutoTags"></div>
    </div>

    <div class="modal-section" id="modalExistingSection">
      <div class="modal-section-label">å·²æœ‰æ ‡ç­¾ï¼ˆç‚¹å‡»æ·»åŠ ï¼‰</div>
      <div class="modal-tags" id="modalExistingTags"></div>
    </div>

    <div class="modal-section">
      <div class="modal-section-label">è‡ªå®šä¹‰æ ‡ç­¾</div>
      <div class="modal-custom-row">
        <input type="text" id="modalCustomInput" placeholder="è¾“å…¥æ–°æ ‡ç­¾ï¼Œå›è½¦æˆ–ç‚¹å‡»æ·»åŠ " maxlength="20" />
        <button id="modalAddBtn" class="outline small">æ·»åŠ </button>
      </div>
      <div class="modal-tags" id="modalCustomTags"></div>
    </div>

    <div class="modal-footer">
      <button id="modalCancelBtn" class="outline">å–æ¶ˆ</button>
      <button id="modalConfirmBtn" class="primary">ä¿å­˜ç¬”è®°</button>
    </div>
  </div>
</div>

<script>
  // --- è…¾è®¯äº‘å¼€å‘ TCB SDK (2.24+ è®¤è¯ API) ---
  const tcbApp = cloudbase.init({
    env: "kt-notebook-5gzea6as40f0fb41",
    region: "ap-shanghai",
    auth: { detectSessionInUrl: true }
  });
  const tcbAuth = tcbApp.auth();
  const CLOUD_PATH     = "notes/notebook.json";
  const STORAGE_KEY    = "study_notes_v1";
  const FILE_ID_KEY    = "cloud_file_id_v1";
  // å…œåº• fileIDï¼šæ ¼å¼ä¸º cloud://{envId}.{envId}-{appId}/{path}
  // appId 1313442109 å–è‡ªåŸŸå kt-notebook-5gzea6as40f0fb41-1313442109.tcloudbaseapp.com
  const CLOUD_FILE_ID_DEFAULT = "cloud://kt-notebook-5gzea6as40f0fb41.kt-notebook-5gzea6as40f0fb41-1313442109/notes/notebook.json";

  /**
   * @typedef {Object} Note
   * @property {number}   id
   * @property {string}   date      YYYY-MM-DDï¼ˆæ—¥æœŸï¼Œç”¨äºåˆ†ç»„/ç­›é€‰ï¼‰
   * @property {string}   datetime  YYYY-MM-DD HH:mm:ssï¼ˆå®Œæ•´åˆ›å»ºæ—¶é—´ï¼Œäººç±»å¯è¯»ï¼‰
   * @property {string}   text
   * @property {string[]} tags
   * @property {number}   createdAt æ¯«ç§’æ—¶é—´æˆ³ï¼ˆç”¨äºæ’åºå’Œåˆå¹¶å»é‡ï¼‰
   */

  /** @type {Note[]} */
  let notes = [];
  let activeTag = null;

  // --- å·¥å…·å‡½æ•° ---
  function getTodayStr() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  /** å°†ä»»æ„ Date å¯¹è±¡æ ¼å¼åŒ–ä¸º "YYYY-MM-DD HH:mm:ss" */
  function formatDatetime(d) {
    const y  = d.getFullYear();
    const mo = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");
    const h  = String(d.getHours()).padStart(2, "0");
    const mi = String(d.getMinutes()).padStart(2, "0");
    const s  = String(d.getSeconds()).padStart(2, "0");
    return `${y}-${mo}-${da} ${h}:${mi}:${s}`;
  }

  function setSyncBadge(state) {
    const el = document.getElementById("syncBadge");
    if (!el) return;
    const map = {
      online:  { text: "â— å·²åŒæ­¥",  cls: "sync-online"  },
      offline: { text: "â—‹ ç¦»çº¿",    cls: "sync-offline" },
      syncing: { text: "â†‘ åŒæ­¥ä¸­â€¦", cls: "sync-syncing" },
      error:   { text: "âœ• åŒæ­¥å¤±è´¥", cls: "sync-error"  },
    };
    const s = map[state] || map.offline;
    el.textContent = s.text;
    el.className   = "sync-badge " + s.cls;
  }

  async function saveNotes() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
    setSyncBadge("syncing");
    try {
      const blob = new Blob([JSON.stringify(notes)], { type: "application/json" });
      const file = new File([blob], "notebook.json", { type: "application/json" });
      const uploadRes = await tcbApp.uploadFile({ cloudPath: CLOUD_PATH, filePath: file });
      // æŒä¹…åŒ– SDK è¿”å›çš„çœŸå® fileIDï¼Œé¿å…æ‰‹åŠ¨æ‹¼æ¥ bucket åå‡ºé”™
      if (uploadRes?.fileID) {
        localStorage.setItem(FILE_ID_KEY, uploadRes.fileID);
        console.log("[Storage] ä¸Šä¼ æˆåŠŸï¼ŒfileID:", uploadRes.fileID);
      }
      setSyncBadge("online");
    } catch (err) {
      console.error("[Storage] äº‘å­˜å‚¨å†™å…¥å¤±è´¥ï¼š", err);
      setSyncBadge("error");
    }
  }

  function loadNotesFromLocal() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      notes = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(notes)) notes = [];
    } catch (e) { notes = []; }
  }

  /**
   * åˆå¹¶äº‘ç«¯ä¸æœ¬åœ°ç¬”è®°ï¼ˆæŒ‰ id å»é‡ï¼ŒåŒ id å– createdAt æ›´æ–°çš„ï¼‰ï¼Œé¿å…ç›´æ¥è¦†ç›–å¯¼è‡´ä¸¢æ•°æ®
   * @param {Note[]} cloudNotes äº‘ç«¯æ•°æ®
   * @param {Note[]} localNotes æœ¬åœ°æ•°æ®
   * @returns {Note[]} åˆå¹¶åçš„åˆ—è¡¨ï¼ŒæŒ‰ createdAt æ’åº
   */
  function mergeNotes(cloudNotes, localNotes) {
    const byId = new Map();
    const add = (list) => {
      if (!Array.isArray(list)) return;
      for (const n of list) {
        if (!n || n.id == null) continue;
        const existing = byId.get(n.id);
        const created = n.createdAt != null ? n.createdAt : 0;
        if (!existing || (existing.createdAt != null && created > existing.createdAt)) {
          byId.set(n.id, n);
        }
      }
    };
    add(cloudNotes);
    add(localNotes);
    return Array.from(byId.values()).sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
  }

  // è·å–å½“å‰æ‰€æœ‰å·²æœ‰æ ‡ç­¾
  function getAllExistingTags() {
    const set = new Set();
    for (const n of notes) {
      if (Array.isArray(n.tags)) {
        for (const t of n.tags) {
          if (t) set.add(t);
        }
      }
    }
    return Array.from(set);
  }

  // ç®€å•çš„æ ‡ç­¾æå–ï¼š#æ ‡ç­¾ + é«˜é¢‘è‹±æ–‡å•è¯ + æ–‡æœ¬ä¸­å‡ºç°çš„å·²æœ‰æ ‡ç­¾
  function extractTagsFromText(text, existingTags = []) {
    const tagsSet = new Set();

    // 1) è¯†åˆ« #æ ‡ç­¾
    const hashTagRegex = /#([\p{L}\d_]{1,20})/gu;
    let match;
    while ((match = hashTagRegex.exec(text)) !== null) {
      tagsSet.add(match[1]);
    }

    // 2) è‹±æ–‡å…³é”®è¯ï¼ˆæŒ‰é¢‘ç‡ç»Ÿè®¡ï¼‰
    const lower = text.toLowerCase();
    const words = lower.match(/[a-z]{3,}/g) || [];
    const stopwords = new Set([
      "the", "and", "for", "with", "that", "this",
      "you", "are", "not", "but", "all", "any",
      "can", "your", "from", "have", "has", "will",
      "just", "about", "into", "more", "when", "then",
    ]);
    const freq = new Map();
    for (const w of words) {
      if (stopwords.has(w)) continue;
      freq.set(w, (freq.get(w) || 0) + 1);
    }

    const sorted = [...freq.entries()].sort((a, b) => b[1] - a[1]);
    for (let i = 0; i < sorted.length && i < 5; i++) {
      const word = sorted[i][0];
      tagsSet.add(word);
    }

    // 3) æ–‡æœ¬ä¸­å‡ºç°çš„å·²æœ‰æ ‡ç­¾
    const lowerText = text.toLowerCase();
    for (const tag of existingTags) {
      if (!tag) continue;
      if (lowerText.includes(tag.toLowerCase())) {
        tagsSet.add(tag);
      }
    }

    return Array.from(tagsSet);
  }

  // --- DOM å¼•ç”¨ ---
  const dateInput = document.getElementById("dateInput");
  const noteInput = document.getElementById("noteInput");
  const saveBtn = document.getElementById("saveBtn");
  const todayBtn = document.getElementById("todayBtn");
  const charCount = document.getElementById("charCount");
  const tagListEl = document.getElementById("tagList");
  const noteListEl = document.getElementById("noteList");
  const noteSummaryEl = document.getElementById("noteSummary");
  const filterInfoEl = document.getElementById("filterInfo");
  const clearAllBtn = document.getElementById("clearAllBtn");

  // åˆ é™¤æŸä¸ªæ ‡ç­¾ï¼šä»æ‰€æœ‰ç¬”è®°ä¸­ç§»é™¤
  function deleteTagEverywhere(tagToDelete) {
    let changed = false;
    for (const note of notes) {
      if (Array.isArray(note.tags) && note.tags.includes(tagToDelete)) {
        note.tags = note.tags.filter((t) => t !== tagToDelete);
        changed = true;
      }
    }
    if (changed) {
      saveNotes();
    }
    if (activeTag === tagToDelete) {
      activeTag = null;
    }
    render();
  }

  // ç»™ tag ç»‘å®šäº‹ä»¶ï¼šå·¦é”®ç­›é€‰ï¼Œå³é”®åˆ é™¤
  function attachTagEvents(tagElement, tag) {
    // å·¦é”®ç‚¹å‡»ï¼šç­›é€‰
    tagElement.addEventListener("click", (e) => {
      if (e.button !== 0) return;
      if (activeTag === tag) {
        activeTag = null;
      } else {
        activeTag = tag;
      }
      render();
    });

    // å³é”®ï¼šåˆ é™¤ tagï¼ˆæ‰€æœ‰ç¬”è®°ï¼‰
    tagElement.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      const ok = confirm(`ä»æ‰€æœ‰ç¬”è®°ä¸­åˆ é™¤æ ‡ç­¾ã€Œ${tag}ã€ï¼Ÿ`);
      if (!ok) return;
      deleteTagEverywhere(tag);
    });
  }

  // --- æ¸²æŸ“ ---
  function render() {
    renderSummary();
    renderTags();
    renderNotes();
  }

  function renderSummary() {
    noteSummaryEl.textContent = `å…± ${notes.length} æ¡ç¬”è®°`;
    if (activeTag) {
      filterInfoEl.textContent = `æŒ‰æ ‡ç­¾ã€Œ${activeTag}ã€ç­›é€‰ä¸­`;
    } else {
      filterInfoEl.textContent = "æœªç­›é€‰";
    }
  }

  function renderTags() {
    const tagCount = new Map();
    for (const n of notes) {
      for (const t of n.tags || []) {
        tagCount.set(t, (tagCount.get(t) || 0) + 1);
      }
    }

    tagListEl.innerHTML = "";
    if (tagCount.size === 0) {
      const span = document.createElement("span");
      span.className = "hint";
      span.textContent = "æš‚æ— æ ‡ç­¾ï¼Œå†™å‡ æ¡æ—¥å¿—è¯•è¯•å§ï½";
      tagListEl.appendChild(span);
      return;
    }

    const sortedTags = [...tagCount.entries()].sort((a, b) => b[1] - a[1]);

    for (const [tag, count] of sortedTags) {
      const div = document.createElement("div");
      div.className = "tag-chip" + (activeTag === tag ? " active" : "");
      div.textContent = tag;

      const countSpan = document.createElement("span");
      countSpan.className = "count";
      countSpan.textContent = `Ã—${count}`;
      div.appendChild(countSpan);

      attachTagEvents(div, tag);
      tagListEl.appendChild(div);
    }
  }

  function renderNotes() {
    noteListEl.innerHTML = "";
    let list = notes.slice();

    list.sort((a, b) => b.createdAt - a.createdAt);

    if (activeTag) {
      list = list.filter((n) => n.tags && n.tags.includes(activeTag));
    }

    if (list.length === 0) {
      const empty = document.createElement("div");
      empty.className = "note-empty";
      empty.textContent = activeTag
        ? "å½“å‰æ ‡ç­¾ä¸‹è¿˜æ²¡æœ‰ç¬”è®°ï½"
        : "è¿˜æ²¡æœ‰ä»»ä½•ç¬”è®°ï¼Œè¯•ç€å†™ä¸€æ¡å§ã€‚";
      noteListEl.appendChild(empty);
      return;
    }

    for (const note of list) {
      const item = document.createElement("div");
      item.className = "note-item";

      const header = document.createElement("div");
      header.className = "note-header";

      const dateSpan = document.createElement("span");
      dateSpan.className = "note-date";
      // ä¼˜å…ˆä½¿ç”¨å®Œæ•´ datetime å­—æ®µï¼Œæ—§æ•°æ®å›é€€åˆ° date + createdAt æ‹¼æ¥
      dateSpan.textContent = note.datetime
        ? note.datetime
        : note.date + " " + new Date(note.createdAt).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

      const metaSpan = document.createElement("span");

      header.appendChild(dateSpan);
      header.appendChild(metaSpan);

      const body = document.createElement("div");
      body.className = "note-body";
      body.textContent = note.text;

      item.appendChild(header);
      item.appendChild(body);

      if (note.tags && note.tags.length > 0) {
        const tagContainer = document.createElement("div");
        tagContainer.className = "note-tags";

        for (const t of note.tags) {
          const tagEl = document.createElement("span");
          tagEl.className = "tag-chip small";
          tagEl.textContent = t;

          attachTagEvents(tagEl, t);
          tagContainer.appendChild(tagEl);
        }
        item.appendChild(tagContainer);
      }

      noteListEl.appendChild(item);
    }
  }

  // --- æ ‡ç­¾é€‰æ‹©å¼¹çª— ---
  const tagModalEl      = document.getElementById("tagModal");
  const modalPreviewEl  = document.getElementById("modalPreview");
  const modalAutoEl     = document.getElementById("modalAutoTags");
  const modalExistEl    = document.getElementById("modalExistingTags");
  const modalCustomEl   = document.getElementById("modalCustomTags");
  const modalCustomInput = document.getElementById("modalCustomInput");
  const modalAutoSection  = document.getElementById("modalAutoSection");
  const modalExistSection = document.getElementById("modalExistingSection");

  // å¼¹çª—çŠ¶æ€
  const modal = {
    pendingText: "",
    pendingDate: "",
    selectedSet: new Set(),
    customTags: [],
  };

  function renderModalTagList(container, tags, isCustom = false) {
    container.innerHTML = "";
    if (tags.length === 0) {
      const hint = document.createElement("span");
      hint.className = "modal-empty-hint";
      hint.textContent = "ï¼ˆæ— ï¼‰";
      container.appendChild(hint);
      return;
    }
    for (const tag of tags) {
      const chip = document.createElement("span");
      chip.className = "modal-tag" + (isCustom ? " custom" : "") + (modal.selectedSet.has(tag) ? " selected" : "");
      chip.textContent = tag;
      chip.addEventListener("click", () => {
        if (modal.selectedSet.has(tag)) {
          modal.selectedSet.delete(tag);
        } else {
          modal.selectedSet.add(tag);
        }
        chip.classList.toggle("selected", modal.selectedSet.has(tag));
      });
      container.appendChild(chip);
    }
  }

  function openTagModal(text, date) {
    modal.pendingText = text;
    modal.pendingDate = date;
    modal.customTags  = [];
    modal.selectedSet = new Set();

    // è‡ªåŠ¨æå–å¹¶é¢„é€‰
    const existingTags = getAllExistingTags();
    const autoTags     = extractTagsFromText(text, existingTags);
    autoTags.forEach(t => modal.selectedSet.add(t));

    // å·²æœ‰æ ‡ç­¾ä¸­æ’é™¤è‡ªåŠ¨æå–çš„
    const extraExisting = existingTags.filter(t => !autoTags.includes(t));

    // é¢„è§ˆæ–‡æœ¬
    modalPreviewEl.textContent = text.length > 80 ? text.slice(0, 80) + "â€¦" : text;

    // æ¸²æŸ“å„åŒºåŸŸ
    modalAutoSection.style.display = autoTags.length ? "" : "none";
    renderModalTagList(modalAutoEl, autoTags, false);

    modalExistSection.style.display = extraExisting.length ? "" : "none";
    renderModalTagList(modalExistEl, extraExisting, false);

    modalCustomEl.innerHTML = "";
    modalCustomInput.value  = "";

    tagModalEl.style.display = "flex";
    setTimeout(() => modalCustomInput.focus(), 50);
  }

  function closeTagModal() {
    tagModalEl.style.display = "none";
    modal.pendingText = "";
    modal.pendingDate = "";
  }

  function addCustomTag() {
    const val = modalCustomInput.value.trim();
    if (!val) return;
    if (modal.customTags.includes(val) || modal.selectedSet.has(val)) {
      modalCustomInput.value = "";
      return;
    }
    modal.customTags.push(val);
    modal.selectedSet.add(val);
    renderModalTagList(modalCustomEl, modal.customTags, true);
    modalCustomInput.value = "";
    modalCustomInput.focus();
  }

  document.getElementById("modalAddBtn").addEventListener("click", addCustomTag);

  modalCustomInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); addCustomTag(); }
  });

  document.getElementById("modalCancelBtn").addEventListener("click", closeTagModal);

  // ç‚¹å‡»é®ç½©å…³é—­
  tagModalEl.addEventListener("click", (e) => {
    if (e.target === tagModalEl) closeTagModal();
  });

  document.getElementById("modalConfirmBtn").addEventListener("click", () => {
    const finalTags = Array.from(modal.selectedSet);
    const now = new Date();
    const newNote = {
      id: now.getTime(),
      date: modal.pendingDate,
      datetime: formatDatetime(now),
      text: modal.pendingText,
      tags: finalTags,
      createdAt: now.getTime(),
    };
    notes.push(newNote);
    saveNotes();
    noteInput.value  = "";
    charCount.textContent = "0 å­—";
    closeTagModal();
    render();
  });

  // --- äº‹ä»¶ç»‘å®š ---
  saveBtn.addEventListener("click", () => {
    const text = noteInput.value.trim();
    const date = dateInput.value || getTodayStr();

    if (!text) {
      alert("å†…å®¹ä¸ºç©ºï¼Œå…ˆå†™ç‚¹ä¸œè¥¿å†ä¿å­˜å§ï½");
      return;
    }

    openTagModal(text, date);
  });

  noteInput.addEventListener("input", () => {
    const len = noteInput.value.length;
    charCount.textContent = `${len} å­—`;
  });

  todayBtn.addEventListener("click", () => {
    dateInput.value = getTodayStr();
  });

  clearAllBtn.addEventListener("click", () => {
    if (notes.length === 0) return;
    const ok = confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¬”è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚");
    if (!ok) return;
    notes = [];
    saveNotes();
    activeTag = null;
    render();
  });

  // --- é¢æ¿æ‹–æ‹½è°ƒèŠ‚ ---
  const resizeHandle = document.getElementById("resizeHandle");
  const paneLeft = document.getElementById("paneLeft");
  const paneRight = document.getElementById("paneRight");
  const mainEl = document.querySelector("main");

  let isResizing = false;
  let resizeStartX = 0;
  let resizeStartLeftWidth = 0;
  let resizeStartRightWidth = 0;

  resizeHandle.addEventListener("mousedown", (e) => {
    e.preventDefault();
    isResizing = true;
    resizeStartX = e.clientX;
    resizeStartLeftWidth = paneLeft.offsetWidth;
    resizeStartRightWidth = paneRight.offsetWidth;
    resizeHandle.classList.add("dragging");
    document.body.style.cursor = "col-resize";
    document.body.style.userSelect = "none";
  });

  document.addEventListener("mousemove", (e) => {
    if (!isResizing) return;
    const dx = e.clientX - resizeStartX;
    const minWidth = 200;
    const maxLeft = resizeStartLeftWidth + resizeStartRightWidth - minWidth;
    let newLeft = Math.max(minWidth, Math.min(maxLeft, resizeStartLeftWidth + dx));
    let newRight = resizeStartLeftWidth + resizeStartRightWidth - newLeft;
    paneLeft.style.flex = "none";
    paneRight.style.flex = "none";
    paneLeft.style.width = newLeft + "px";
    paneRight.style.width = newRight + "px";
  });

  document.addEventListener("mouseup", () => {
    if (!isResizing) return;
    isResizing = false;
    resizeHandle.classList.remove("dragging");
    document.body.style.cursor = "";
    document.body.style.userSelect = "";
  });

  // --- åˆå§‹åŒ– ---
  async function init() {
    dateInput.value = getTodayStr();

    window.addEventListener("online",  () => setSyncBadge("online"));
    window.addEventListener("offline", () => setSyncBadge("offline"));

    // ç™»å½•ï¼šä¼˜å…ˆç”¨æˆ·åå¯†ç ï¼Œå¤±è´¥åˆ™é™çº§åŒ¿åç™»å½•ï¼ˆä½¿ç”¨ 2.24+ signInWithPassword / signInAnonymouslyï¼‰
    try {
      const { data: sessionData } = await tcbAuth.getSession();
      if (!sessionData?.session) {
        const { error: pwdErr } = await tcbAuth.signInWithPassword({
          username: "default",
          password: "Default1234"
        });
        if (pwdErr) {
          console.warn("[Auth] ç”¨æˆ·åå¯†ç ç™»å½•å¤±è´¥ï¼Œå°è¯•åŒ¿åç™»å½•ï¼š", pwdErr);
          const { error: anonErr } = await tcbAuth.signInAnonymously();
          if (anonErr) throw anonErr;
          console.log("[Auth] åŒ¿åç™»å½•æˆåŠŸ");
        } else {
          console.log("[Auth] ç™»å½•æˆåŠŸ username: default");
        }
      } else {
        const u = sessionData.session.user;
        const display = u?.user_metadata?.username || u?.user_metadata?.nickName || u?.email || u?.phone || u?.id || "anonymous";
        console.log("[Auth] å·²æœ‰ä¼šè¯ï¼Œå½“å‰ç”¨æˆ·ï¼š", display);
      }
    } catch (e) {
      console.warn("[Auth] TCB ç™»å½•å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼ï¼š", e);
      loadNotesFromLocal();
      render();
      return;
    }

    // ä»äº‘å­˜å‚¨è¯»å–ç¬”è®°ï¼Œä¸æœ¬åœ°åˆå¹¶åå†å†™å›ï¼ˆé¿å…ç›´æ¥è¦†ç›–å¯¼è‡´å¤šç«¯ä¸¢æ•°æ®ï¼‰
    loadNotesFromLocal();
    const localBeforeMerge = notes.length ? notes.slice() : [];

    // ä¼˜å…ˆä½¿ç”¨ä¸Šæ¬¡ä¸Šä¼ æ—¶ SDK è¿”å›å¹¶æŒä¹…åŒ–çš„çœŸå® fileIDï¼Œå¦åˆ™ç”¨ç¡¬ç¼–ç çš„å…œåº•å€¼
    const savedFileId = localStorage.getItem(FILE_ID_KEY) || CLOUD_FILE_ID_DEFAULT;
    console.log("[Storage] ä½¿ç”¨ fileID:", savedFileId,
      localStorage.getItem(FILE_ID_KEY) ? "(æ¥è‡ªç¼“å­˜)" : "(æ¥è‡ªé»˜è®¤å€¼ï¼Œæ¸…é™¤å­˜å‚¨åé¦–æ¬¡åŠ è½½)");

    try {
      // fileList å¿…é¡»æ˜¯å­—ç¬¦ä¸²æ•°ç»„ï¼ˆfileIDï¼‰ï¼Œä¸èƒ½æ˜¯å¯¹è±¡â€”â€”å®˜æ–¹ JS SDK æ–‡æ¡£è§„èŒƒ
      const res = await tcbApp.getTempFileURL({
        fileList: [savedFileId]
      });
      const item = res.fileList[0];
      if (item.code === "SUCCESS" && item.tempFileURL) {
        // ä¸´æ—¶é“¾æ¥è·å–æˆåŠŸï¼Œå°†å½“å‰ä½¿ç”¨çš„ fileID å†™å…¥ç¼“å­˜ï¼ˆå…œåº•é»˜è®¤å€¼ä¹Ÿä¸€å¹¶æŒä¹…åŒ–ï¼‰
        localStorage.setItem(FILE_ID_KEY, savedFileId);
        // æ‹¼æ¥æ—¶é—´æˆ³ç ´å CDN ç¼“å­˜ï¼Œä¿è¯è¯»åˆ°çš„æ˜¯æœ€æ–°ä¸Šä¼ çš„æ–‡ä»¶
        const freshUrl = item.tempFileURL + (item.tempFileURL.includes("?") ? "&" : "?") + "_t=" + Date.now();
        const resp = await fetch(freshUrl, { cache: "no-store" });
        if (resp.ok) {
          const data = await resp.json();
          const cloudNotes = Array.isArray(data) ? data : [];
          console.log(`[Storage] äº‘ç«¯ notebook.json è¯»å–æˆåŠŸï¼Œæ¡ç›®æ•°ï¼š${cloudNotes.length}`);
          notes = mergeNotes(cloudNotes, localBeforeMerge);
          console.log(`[Storage] åˆå¹¶åæ¡ç›®æ•°ï¼š${notes.length}ï¼ˆæœ¬åœ° ${localBeforeMerge.length} + äº‘ç«¯ ${cloudNotes.length}ï¼‰`);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
          setSyncBadge("online");
          // è‹¥åˆå¹¶ç»“æœä¸äº‘ç«¯ä¸ä¸€è‡´ï¼Œä¸Šä¼ åˆå¹¶åçš„å®Œæ•´æ•°æ®ï¼Œä¿è¯äº‘ä¸Šä¹Ÿæ˜¯æœ€æ–°åˆå¹¶ç‰ˆ
          if (JSON.stringify(cloudNotes) !== JSON.stringify(notes)) {
            console.log("[Storage] äº‘ç«¯ä¸æœ¬åœ°æœ‰å·®å¼‚ï¼Œå›å†™åˆå¹¶ç»“æœåˆ°äº‘å­˜å‚¨â€¦");
            try {
              const blob = new Blob([JSON.stringify(notes)], { type: "application/json" });
              const file = new File([blob], "notebook.json", { type: "application/json" });
              const uploadRes = await tcbApp.uploadFile({ cloudPath: CLOUD_PATH, filePath: file });
              if (uploadRes?.fileID) localStorage.setItem(FILE_ID_KEY, uploadRes.fileID);
              console.log("[Storage] å›å†™å®Œæˆ");
            } catch (e) { console.warn("[Storage] åˆå¹¶åå›å†™äº‘å­˜å‚¨å¤±è´¥ï¼š", e); }
          }
        } else {
          console.warn("[Storage] äº‘ç«¯æ–‡ä»¶è¯·æ±‚å¤±è´¥ï¼ŒHTTP:", resp.status);
        }
      } else {
        console.warn("[Storage] è·å–ä¸´æ—¶é“¾æ¥å¤±è´¥ï¼š", item);
      }
    } catch (err) {
      console.warn("[Storage] äº‘å­˜å‚¨è¯»å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®ï¼š", err);
      setSyncBadge("offline");
    }
    render();
  }

  init();
</script>
</body>
</html>